Improving Spam Blacklisting Through Dynamic Thresholding and
Speculative Aggregation
SushantSinha,MichaelBailey,andFarnamJahanian
UniversityofMichigan,AnnArbor,MI48109,USA
sushant,mibailey,farnam @umich.edu
{ }
Abstract This spam routinely impacts user productivity [21], con-
sumes resources [14], and serves as an infection vector
Unsolicitedbulke-mail(UBE)orspamconstitutesasig- for malicious software [15]. In an effort to reduce these
nificantfractionofalle-mailconnectionattemptsandrou- impacts, two major classes of anti-spam approaches have
tinely frustrates users, consumes resources, and serves as emerged: content-basedfilteringandblacklisting. Content-
an infection vector for malicious software. In an effort to basedfilteringmethods(e.g.,[22,10])relyonclassification
scalablyandeffectivelyreducetheimpactofthesee-mails, algorithms to examine the contents of e-mails (i.e., head-
e-mailsystemdesignershaveincreasinglyturnedtoblack- ers, body) and to differentiate legitimate (or ham) and un-
listing. Blacklisting(blackholing,blocklisting)isaformof solicited (or spam) e-mail. Unfortunately, these methods
course-grained, reputation-based, dynamicpolicyenforce- are easy to evade [27] and can even be co-opted to block
mentinwhichreal-timefeedsofspamsendinghostsaresent legitimate e-mail [16]. In an effort to scalably and effec-
to networks so that the e-mail from these hosts may be re- tively reduce the impact of these e-mails, e-mail system
jected. Unfortunately, current spam blacklist services are designers have increasingly turned to blacklisting. Black-
highly inaccurate and exhibit both false positives and sig- listing (blackholing, block listing) is a form of course-
nificant false negatives. In this paper, we explore the root grained, reputation-based, dynamic policy enforcement in
causes of blacklist inaccuracy and show that the trend to- whichreal-timefeedsofspamsendinghostsaresenttonet-
ward stealthier spam exacerbates the existing tension be- works so that the e-mail from these hosts can be rejected
tween false positives and false negatives when assigning or specially marked. Currently, a large number of orga-
spammingIPreputation. Wearguethattorelievethisten- nizations provide these services for spam detection (e.g.,
sion,globalaggregationandreputationassignmentshould NJABL[1],SORBS[3],SpamHaus[5],andSpamCop[4]).
be replaced with local aggregation and reputation assign- Unfortunately,currentspamblacklistservicesarehighly
ment,utilizingpreexistingglobalspamcollection,withthe inaccurate and exhibit both false positives and significant
addition of local usage, policy, and reachability informa- false negatives. For example, in a previous study of four
tion. We propose two specific techniques based on this prominentblacklistsincludingSORBS,SpamHaus,Spam-
premise,dynamicthresholdingandspeculativeaggregation, Cop,andNJABL,falsepositivesrangedfrom0.2%to9.5%
whosegoalistoimprovetheaccuracyofblacklistgenera- and false negatives ranged from 35% to 98.4% [23]. To
tion. We evaluate the performance and accuracy of these compensate for these limitations, blacklists are often used
solutionsinthecontextofourowndeploymentconsistingof in conjunction with content-base techniques to further im-
2.5millionproductione-mailsand14millione-mailsfrom prove effectiveness [13]. However, the accuracy of spam
spamtraps deployed in 11 domains over a month-long pe- blacklistservicesremainsimportantastheyareusedreduce
riod. We show that the proposed approaches significantly thecostofexecutingthemoreexpensivecontent-basedfil-
improve the false positive and false negative rates when tersandoftensuccessfullyblackliste-mailthatthecontent-
comparedtoexistingapproaches. filters fail to capture. While numerous novel blacklisting
systems have been created (e.g., [20, 11]) to address this
need, little work has focused on understanding why exist-
ing methods fail and how these methods might be directly
1 Introduction
improved.
In this paper, we explore the factors that affect the ac-
Recentestimatesindicatethatasmuchas94%ofallIn- curacy of traditional blacklisting techniques. We evaluate
ternete-mailisunsolicitedbulke-mail(UBE)orspam[24]. both factors that are inherent to the evolution of spammerbehavior(e.g.,targetedspam,lowrateor“snowshoe”),as Thistechniqueimprovestheaccuracyofgenerationby: (i)
wellasthoseintegraltotheapproachitself(e.g., detection predicting potential new sources of spamming before they
delay, over or under aggressive blacklisting). In evaluat- hit spam collectors and (ii) limiting the chance that these
ing these factors, we show that the vast number of false predictedhostsornetworksareofusetothelocalnetwork.
negatives come from IP addresses that have sent limited To validate our techniques, we collected headers from
numbers of e-mail to each domain and very few domains both a production e-mail system of a large academic de-
overall, limiting the amount of information available with partment,whichreceived2.5millione-mails,andourown
whichtomakereputationassignments. Furthermore,many separatespamtrapdeployment,whichreceived14millione-
ofthefalsepositivesareattributabletotheblockingofhigh mails,duringthemonth-longevaluationperiodofFebruary-
volume,multi-userdomains(e.g.,web-mail)ortothelack March, 2009. We built blacklists based on e-mails re-
of appropriate whitelisting to avoid such problems. We ceived on the spamtrap and on the e-mails received on
believe this fundamental tension between the increasingly the production network. We evaluated the blacklists us-
small number of events with which to assign reputation to ing a combination of SpamAssassin and manual examina-
an individual IP and the accuracy of the reputation result tion. In our evaluation, we found that these approaches
mustbeovercomeifthesemethodsaretobeimproved. performed significantly better than our implementation of
In order to address this tension, we propose two novel existing approaches—the detection rate for the dynamic
techniques: dynamicthresholdingandspeculativeaggrega- thresholdingapproachisthreetimesthatoftheexistingap-
tion.Fundamentally,thesetechniquesworkbysupplement- proachesforafalsepositiveratebelow0.5%,andthespec-
ing spam events with local policy, usage, and routing data ulativeaggregationapproachprovidesfivetimesthedetec-
andbymovingtheblacklistaggregationanddecisionmak- tionratewhencomparedtotheexistingapproachforafalse
ingawayfromtheglobalcollectioninfrastructureproviders positiveratebelow0.5%.
to the local network that is enforcing the policy decision. Tosummarize,themaincontributionsofthispaperare:
In dynamic thresholding, the determination to blacklist a
spammingIPisneitherglobal,norbasedonastaticthresh- Anexaminationoftherootcausesofblacklistineffec-
•
oldandwhitelistcombination,butratherbasedontherela- tiveness. Wearguethatthedecreasingnumberofob-
tiveimportanceofaremoteIPaddresstothelocalnetwork. servable spam events for a given IP severely hampers
These local, customized blacklists are created by tracking theaccuracyofthesetechniques.
the ratio of spam events for a remote IP to the number of
outbounde-mailsfromthelocalnetworktothatremoteIP. We propose two techniques that address these root
•
The value of this technique is that: (i) it allows more ag- causes: dynamic thresholding and speculative aggre-
gressivethresholdselectionforremotedomainsthatarenot gation. We argue that blacklist generation techniques
used often by the local network (ii) it alleviates the need shouldtakeintoaccountbothlocalusage,policy,and
for manual (and sometimes arbitrary or punitive) whitelist reachability information as well as global reputation
selection,asimportantremoteIPsanddomainswillnotbe datawhenmakingpolicydecisionsandthatthesepol-
blacklistedunlesstheybecome“moretroublethantheyare icydecisionsshouldbemadelocallyratherthanglob-
worth,” and (iii) policies are now local to the networks in ally. By shifting the location of these decisions and
which they are applied, allowing unique, dynamic thresh- addinglocalcontext,wearguethatweimprovetheac-
oldsandwhitelistsforeachandeveryorganization. curacyofthereputationassignment.
Inthesecondapproach,speculativeaggregation,weuse
globalinformationprovidedbyspamtrapsandBGPreacha- An evaluation of these techniques on data collected
•
bilityinformationtodeterminetheratioofgood(andactive) fromalargeacademicdepartmentale-mailserverand
IPaddresseswithinablocktothenumberofspammingIP a demonstration of these two techniques that shows
addresseswithinablock.Basedontheprevalentnotionthat significantimprovementoverexistingmethods.
spammingIPsareclustered[11,26],theratioofspamming
tonon-spamminghostsinanetworkblockisagoodpredic- Theremainderofthispaperisstructuredasfollows: We
toroffuturespammingactivityforavarietyofreasons,in- begininSection2byexploringtherootcausesofexisting
cludingsharedadministrativeandsecuritypolicies,anddy- blacklistfailure. Thearchitecturesection,Section3,intro-
namichosts. Thedangerofsuchanapproach,obviously,is ducesthespeculativeaggregationanddynamicthresholding
thatitmayblockentireprefixes,someofwhichsendlegiti- techniquesthatmakeupoursystemandSection4evaluates
matee-mailtothelocalnetwork. Toamelioratethiseffect, theseapproachesinourproductiondeployment. Section5
we layer dynamic thresholding techniques on top of spec- providesabriefoverviewofrelatedwork. Weconcludein
ulative execution to allow e-mail from bad neighborhoods Section6bydiscussingthelimitationsofandfutureofthis
if these neighborhoods are important to the local network. work.BlACKLIST Deny All Bot1
Provider Deny All Bot2
Bot1 Trap1 Trap2
User2
User3
User1
Spammer
Bot2
User4
Figure1: Inexistingapproachestoblacklistgeneration,spamissenttobothlegitimateusersaswellasunusedaccountsanddo-
mains(spamtraps).Spamisaggregatedbyablacklistingproviderandglobalproviderconfiguration(inclusionthreshold,whitelist-
ing)isappliedtodetermineblacklistcontents. Customernetworksmaychoosetolocallyimplementthepublishedblacklistpolicy
(i.e.,blockorspeciallymarke-mailfromthoseIPs).
2 ExploringtheInaccuracyofBlacklists userswithinalegitimatedomain.Inthisdeploymentmodel,
the e-mail server delivers all e-mails directed to existing
Spamblacklistsserveanimportantroleinblockingun- userstotheirrespectivefolders,butanye-maildirectedtoa
wantede-mailtraffic.Inthissection,weexaminethefactors nonexistentuserisdeliveredtoaseparateaccount.
thatlimitexistingspamblacklistaccuracyinanefforttoun- E-mails sent to spamtraps are then aggregated by a
derstandhowtoimprovethem. Webeginbydescribingex- blacklist provider, as shown in Figure 1. The e-mails are
istingmethodsforblacklistcreationandproceedtodiscuss aggregated by source IP and those IP addresses that ex-
the experimental setup used throughout this analysis (and ceed a threshold number of spamtrap hits within a given
the remainder of this paper) including the oracle we used, time window are blacklisted [7]. Since legitimate e-mail
the production e-mail network, and our spamtrap deploy- servers, such as yahoo.com, can also be used by spam-
ment.Bycreatingourownblacklistandanalyzingitseffec- mers,thedangerofathreshold-basedapproachisthatitcan
tivenessinthecontextofourproductione-mailsystem,we blacklist legitimate e-mail servers causing widespread e-
explorethefactors(e.g.,low-rate,low-volumespam,detec- maildisruption. Therefore,commercialblacklistproviders
tiondelay)thatmayimpacttheaccuracyofexistingblack- maintainwhitelistsofpopulare-mailservicesandthenuse
listcreationmethods. Weconcludethattrendsinspammer “Received” headers added by those legitimate servers to
behaviorlimitthenumberofeventsusedtoassignIPrepu- determine the IP addresses of the sender. Unfortunately,
tationandthereforeimpacttheaccuracyofthesemethods. this scheme does not work universally. For example, this
schemedoesnotworkwithGmailbecauseGmaildoesnot
addthesourceIPoftheclient, ifthewebinterfaceisused
2.1 Background
for sending the e-mail [23]. In addition, SpamCop uses a
sampleofDNSlookupstodetermineifIPaddressesshould
A number of organizations generate dynamic blacklists
avoidbeingblacklisted.However,thismaynotbeareliable
forspamincluding: SORBS[3],SpamHaus[5]andSpam-
estimateofactuale-mailsdelivered(e.g.,DNScaching).
Cop[4]. Thesespamblacklistprovidersdeployandmoni-
toranumberofunusede-mailaddressescalledspamtraps.
2.2 ExperimentalSetup
Therearetwogeneralapproachestospamtrapdeployment.
The first approach is to configure an e-mail server for an
unuseddomain. Forexample,ProjectHoneypot[25]takes Weevaluatetheeffectivenessofspamblacklists,aswell
unused sub-domains, like mail1.umich.edu, within legiti- as the other results in this paper, by observing e-mails to
mate domains, like umich.edu, and monitors all e-mails to andfromalargeacademicinstitution. Inourexperiments,
these domains. The second approachis to monitor unused we observed over 7,000 local hosts during a month-longperiod from February 10, 2009 to March 10, 2009. We Toplevel E-Mails The%oftotal Unique
monitored traffic using a traffic tap (i.e., span port) to the domain received spamtrape-mails sources
gatewayrouterthatprovidesvisibilityintoallofthetraffic .org 289,991 2.1 137,725
exchanged between the network and the rest of the Inter- .org 449,803 3.2 216,291
net. The TCP streams on port 25 were reassembled us- .org 571,856 4.1 253,777
ing libnids [28], and full SMTP formatted e-mails were .com 1,090,611 7.8 407,838
available for evaluation. During the measurement period .net 1,159,353 8.3 439,152
we observed a total of 3,999,367 SMTP connections, out .net 1,306,411 9.4 473,686
of which 2,575,634 e-mails were successfully delivered. .net† 1,321,232 9.5 18
The remaining SMTP connections failed or were aborted .com 1,458,865 10.5 486,675
inlargepartduetonon-existentusersonthetargetdomain. .com 1,552,240 11.2 521,321
.net 1,698,295 12.2 513,057
.net 3,004,583 21.6 689,633
2.2.1 OracleSelection
Table 1: Our spamtrap deployment by top level domains,
In order to evaluate blacklist accuracy, we need to deter-
number of e-mails received, and number of unique sources.
mine whether an e-mail on the production network is ham
Over 14 million spam e-mails were captured and analyzed.
(legitimatee-mail)orspam. Atthescaleoftheabovemea-
†This domain received between 28,244-58,597 spam e-mails
surement,ahandclassificationofe-mailswasinfeasibleand
from2-11uniquesourceaddressesperday. Interestingly,the
soweusedSpamAssassin[13]asouroracleclassification.
totalnumberofdistinctsourceIPaddresseswassmall(18)and
SpamAssassinusesanumberofspamdetectorsandassigns allofthembelongtoGmail.Weconjecturethedomainwasbe-
scores for each detector. The total score for a message is ingspammedusingnumerouscompromisedGmailaccounts.
computedbyaddingthescoreofallthedetectorsthatclas-
sified the message as spam. If the total score exceeds the
default threshold of 5.0, then the message is classified as
and Comcast (25,576). The top five destinations (i.e., au-
spam.WeusedthedefaultSpamAssassinconfigurationthat
tonomoussystems)forlegitimatee-mailfromournetwork
came with the Gentoo Linux distribution. We configured
wereGoogle(87,373),Inktomi(4,559),Microsoft(3,466),
SpamAssassin with two additional detection modules, Py-
Inktomi-II (2,052), and Merit Networks (1,793). The av-
zor [2] and Razor [6], for improving SpamAssassin accu-
erage message size for all e-mails was 5,301 bytes, with
racy. Wediscusstheissueoforacleaccuracyandourman-
averagesof4,555bytes, 15,152bytes, and1,916bytesfor
ualexaminationtocovertheoraclelimitationinSection4.5.
spam,ham,andfailedconnectionsrespectively.
2.2.2 CharacterizingtheE-mailSeenontheNetwork
2.2.3 CharacterizingtheSpamtrapDeployment
Our month-long observation shows that roughly 75% of
In order to understand the issues effecting the root causes
the delivered e-mail (i.e., ham and spam, but not failed
ofthefalsepositivesandfalsenegativesproducedbyexist-
connections) was spam. This number rises to 84% when
ingblacklistaggregationalgorithms,wedeployedourown
failed SMTP connections (due to nonexistent users or do-
spamtrapdeploymentcovering11domainsduringthemea-
mains) are included. We observed 764,248 unique IP ad-
surementperiod.Thee-mailserverinthesedomainscopied
dressesduringthisperiodin35,390distinctBGPprefixes,
e-mailssenttonon-existentuserstoaseparateaccountfor
announced by 85 unique autonomous systems. Most of
post analysis. In total, we observed 13,903,240 e-mails
the spam messages (1,448,680) came from sources exter-
from1,919,911uniquesourcesbetweenFebruary10,2009
nal to our network. However, we had a sizable number
toMarch10,2009.Table1showsthenumberofe-mailsre-
of spams (392,192) from within the network, which was
ceivedandthenumberofuniquesourcesobservedoneach
roughlyfourtimesthenumberofspammessages(98,679)
ofthesedomains. Over14millionspame-mailswerecap-
from hosts within the network to the rest of the Inter-
turedandanalyzed.
net (we send much more spam to ourselves than to the
rest of the Internet). Ham messages were dominated by
2.3 Factors that May Influence Blacklist Accu-
internal to internal e-mails (369,431), followed by inter-
racy
nal to external (151,860), and then by external to internal
(114,792). The top five external senders (i.e., autonomous
systems) of spam observed during this period at our net- Having now described how existing blacklists are cre-
workwereTurkTelekom(69,278),Verizon(34,819),Tele- atedandthecontextinwhichweperformourexperiments,
comunicacoes Brazil (34,175), TELESC Brazil (27,360), we now embark on an exploration of the reasons for theNumber ORofdomains ANDofdomains 100000
of FP FN FP FN
10000
domains rate rate rate rate
1 2.2 71.5 2.2 71.5 1000
2 2.2 66.7 1.0 80.58
100
3 2.2 63.6 1.0 83.54
4 2.3 61.6 0.0 100.0 10
5 2.3 61.6 0.0 100.0
1
6 2.3 60.4 0.0 100.0
7 2.3 59.2 0.0 100.0 0.1
0 50000 100000 150000 200000 250000 300000
8 2.4 58.2 0.0 100.0
9 2.4 57.5 0.0 100.0
10 2.4 57.0 0.0 100.0
11 2.4 56.8 0.0 100.0
Table2: Thefalsepositiveandfalsenegativesrateswhenthe
spamtrap deployment is expanded domain by domain using
existing methods. No spamming IP address is seen by more
thanthreespamtraps.
false positives and false negatives we observed. We ex-
amine two broad categories of potential reasons for these
inaccuracies, including trends in spamming behavior (i.e.,
targeted spam, low-volume spam) and systemic properties
oftheblacklistcreationmethods(i.e,detectiondelay,static
whitelisting).
2.3.1 TargetedE-Mail
One possible explanation for the false negative rates ob-
served by the blacklists is that some of the e-mails are
part of a targeted spam campaign. Obviously, if a spam-
mersendstargetedspamtoadomaininwhichthereareno
spamtraps,itisimpossibletoblacklistthehost. Toexplore
theimpactofthispotentialcauseoffalsenegatives,weex-
amined the impact of spamtrap deployment size on accu-
racy. Bybuildingblacklistsfromspamtrapdeploymentsof
size1,2,...,11wecanexplorethetargetednatureofspam.
Table2showstheresultofthisanalysis. Weconsidertwo
cases for blacklist generation, one in which an IP address
is blacklisted if a spam host appears on any spamtrap do-
main,andoneinwhichitisblacklistedifitappearsonev-
eryspamtrapdomain. ThefalsenegativeratefortheORof
domainsconvergetoroughly56.8%,indicatingthatroughly
57%ofthespamdoesnotappearinanyofthespamtraps—
areasonableupperboundontheamountoftargetede-mail.
Alowerboundontheamountofglobale-mailcanbeseen
in the false negative rate for the AND of domains, 100%
after just three spamtrap domains are combined. Clearly,
globalspamseemstobequitelimited. Whileaprecisees-
timateisdifficultwithoutauniversaldeployment,itisclear
that the blacklists are impacted by significant targeted be-
mapS
fo
rebmuN
External spam IPs not observed on spamtrap
Figure2: Thenumberofe-mailssentbyexternalspamming
sourcesthatwerenotobservedonanyspamtrap.Mostofthese
sourcessentjustonespamtoournetwork.
havior.
2.3.2 LowVolumeSpam
Another potential explanation of the false negatives ob-
served is that although the campaigns are global, the vast
numberofhostsavailabletospammersmakesitfeasibleto
sendasmallhandfulofe-mailsfromeachhosttoeachtar-
get user or domain and still send millions of mails. This
contributes to the problem of false negatives, in that most
blacklistproviderswillnotblacklisthostsforasinglespam
senttoaspamtrap. Inordertoinvestigatethisphenomenon,
we examined the spam sent to our network that was not
observed on ANY of our spamtraps. For each spamming
source,wecalculatedthenumberofspamssenttoournet-
workoverthemeasurementperiod. AsshowninFigure2,
while some spammers clearly sent numerous spams, the
vastmajorityofsourcessendingspamtoournetworkonly
sent a single spam. Therefore, any approach that requires
multiplespamtraphitswillneverreportthesehigh-volume,
single-targetsourcesasspammers.
2.3.3 DetectionDelay
Athirdpotentialsourceoffalsenegativesisthereactivena-
ture of blacklist generation. By their nature, hosts are not
put on blacklists until they send enough e-mail to spam-
traps. Duringafastglobalcampaign,itispossiblethatwe
mightreceivethespamattheproductionnetworkbeforeit
reachesaspamtraporbeforetheblacklistprovidercansend
out an update. To explore the impact of this delay, we ex-
aminedtheideaofretroactivedetection.Thatis,wecreated
blacklists as expected, creating blacklist entries for spam-
ming hosts only if they sent spam over a given threshold.
We then enabled retroactive detection, that is, we classi-
fied hosts as spam if they sent e-mail to the spamtraps at100
95
90
85
80
75
70
65
60
55
1 10 100 1000 10000
)%(
sevitagen
eslaF
1
with_time_filter
without_time_filter
0.8
0.6
0.4
0.2
0
0.1 1 10 100 1000 10000 100000
Threshold on spamtrap hits
Figure 3: The effect of blacklist detection delay on false
negatives for different thresholds using existing blacklisting
approaches. The difference between blacklisting only those
spammingIPaddresseswhosespamtraphitsoccurbeforean
e-mail is received on the production network is compared to
blacklistingtheIPaddressifitappearsanywhereinthetrace
(often in the future). The biggest cost of detection lag is for
smallthresholdvaluesintraditionalapproaches.
anytimeduringourobservations(potentiallyseveralweeks
after we observed the spam). Figure 3 shows the result of
this analysis. For small threshold values (i.e., blacklisting
whenweseeonlyonespam)thedecreaseinfalsenegatives
from retroactive detection is 10%. For higher thresholds,
thisvaluedecreases. Thus10%approximatesareasonable
upperboundonthefalsenegativescausedbydelay.
2.3.4 StaticWhitelisting
Falsepositivesoccurfromblacklistswhenlegitimatee-mail
servers are blocked. Often times this occurs when a legit-
imatee-mailseverhasbeencompromisedorisbeingused
bycompromisedhosts. Inmanycasesthiscanbeavoided,
as the e-mail server can add the IP address of the sending
host in the e-mail headers, but this is not always the case.
Forexample,e-mailssentfromtheGmailwebinterfacedo
not include the client’s IP address, and as a result, black-
listsareonlyleftwiththechoiceofblacklistingtheserver
itself. Whattheseblacklistslackisanotionofwhatservers
areusedandnotusedbyaspecificnetwork. Forexample,
considerthedatainFigure4. Inthisfigure,weexaminethe
amountofmailwesenttothosenetworks(autonomoussys-
tems)thatsentusspamandthosethatsentusham.Notethe
starkcontrastbetweenthee-mailwesenttolegitimatenet-
works and those we sent to spamming networks—90% of
hamsendersreceivedmorethanonee-mailfromus,while
over60%ofspammersneverreceivedasinglee-mailfrom
our network. A few spamming domains received a large
number of e-mails from us. As expected, these are false
positives from web hosting sites as in the example above:
noitcnuF
noitubirtsiD
evitalumuC
Ham sent to ham senders
Ham sent to spam senders
Number of emails sent
Figure4:Theamountoflegitimatee-mailsentbyournetwork
tonetworksthatsentusspamandlegitimatee-mail.Thereisa
hugedifferenceinhowournetworkusestheIPaddressesthat
sentspamandthosethatdonot.
Google (87,373), Inktomi (4,559), and Microsoft (3,466).
Thesesitescouldbewhitelisted,butwithoutknowingwhat
services a network uses, this whitelisting may create false
negatives. Whatblacklistsneedisawaytofigureoutwhat
remotenetworksareimportanttoagivennetwork.
2.3.5 PuttingitTogether
In this section, we explored the root causes of traditional
threshold-basedblacklistcreationalgorithms. Wenotethat
spamisbothtargetedandinmanycases,low-volume. Cap-
turing this spam places pressure to lower detection thresh-
olds to require fewer and fewer spamtrap hits in order to
capturethespammingbehavior. Thispressureplacesaddi-
tionalburdenontheblacklistoperatorstoselecttheappro-
priatewhiteliststoavoidtheincreasingnumberoffalsepos-
itives. This tension is further exacerbated by the delay in-
herentinexistingblacklistingthesemethods,whichismost
pronouncedatpreciselythelowerthresholdsbeingutilized.
Whatisneededthen,areadditionalsourcesofinformation
and methods that can be used to determine when and how
tobeaggressiveinblacklisting.
3 Architecture
In this section, we describe our approach to mitigating
the limitations discussed in the previous section. Rather
thana“onesizefitsall”method,whichisembodiedbythe
generation schemes for existing production blacklists (and
shown in Figure 1), our method (shown in Figure 5) de-
cidesonblacklistingpolicywiththehelpoflocalinforma-
tion including usage patterns (i.e., e-mail usage), network
routingvisibility(i.e.,BGPinformation),aswellasglobal
information (i.e., spamtraps). With local context in hand,BlACKLIST
Provider
Bot1 Trap1
User2
Trap2
User3
User1
Spammer
Time3, Bot1, Trap1
Time4, Bot2, Trap1
Time5, Bot2, Trap2
Deny All Bot1
Bot2
Local
ROUTER Policy Gen.
User4
Time1, User4, User1
Time2, User4, Bot2
Time3, User2, User4
Figure5: Ourapproachtospamblacklistgeneration. Ratherthanenforcingaglobal“onesizefitsall”policy,alocalgeneration
algorithmcombineslocalusagepatterns(i.e,e-mailusage),allocationinformation(i.e.,BGPreachability),andglobalinformation
(i.e.,spamtraps)tomakelocalized,tailoredblacklistpolicies.
the policy generation mechanisms can eliminate false pos- configuredratio. Forexample,considerthattheconfigured
itivesthatoccurfromblacklistinglocallyimportante-mail ratiois1andasourceIPaddressisobserved5timesonthe
servers.Inaddition,theblacklistingcanbemoreaggressive e-mail server and 10 times on the spamtrap. The ratio is
in blacklisting networks rather than individual sources—if 5/10=0.5,whichislowerthantheprovidedratioof1,so
thesenetworksarenotimportantinthelocalcontext.Inthis thissourceIPaddresswillbeblacklisted.
section,weseehowthisgeneralideaisappliedintwospe-
cific improvements to spam blacklist generation: dynamic
3.2 SpeculativeAggregation
thresholdingandspeculativeaggregation.
Whileadynamicthresholdapproachaddressesthefalse
3.1 DynamicThresholding
positive issues with the spam blacklists, the blacklists still
exhibitasignificantamountoffalsenegatives. Recallfrom
In a simple static, threshold-based approach model of theprevioussectionthatthismaybetheresultoflowvol-
existing methods, a threshold is decided and an IP ad- umespammers,targetedspam,ordetectiondelays.Inorder
dress is blacklisted if the number of e-mails sent to spam- toattackfalsepositivesresultingfromsourceswehavenot
trapscrossesthatthreshold. However,thesimplethreshold seen, the only solution we have is to speculate about po-
mechanism can blacklist e-mail servers that are important tentially bad sources. One potential source of information
e-mailservers(e.g.,Gmail)iftheyareusedtosendevena thatwehavetoinformourpredictionisthelistofprevious
small amount of spam. One solution to this problem is to spamming sources. In Figure 6, we aggregated the spam-
comparelocalnetworktraffictothespamtrape-mails. The ming sources that have missed the spamtraps by the BGP
assumptionhereisthatavalide-mailserverwillhavesig- prefixes (obtained from routeviews.org project). We find
nificantlymoree-mailsdeliveredtovalidaddressesthanto that most of these prefixes have a large number of sources
spamtraps, while a spamming source will hit significantly thathavepreviouslyhitspamtraps. Weconclude,therefore,
more spamtraps than legitimate users in the live network, that the number of sources that have hit the spamtraps is
as we saw in Figure 4. Therefore, we propose a dynamic agoodindicationofspammingprefixes. Secondly,wefind
threshold approach that computes the ratio of e-mails on thatmostofthesourcesthathavemissedspamtrapsinthese
thelivenetworktothenumberofe-mailsseenatthespam- prefixes have sent at least one spam as well. Therefore,
trapandblacklistssourcesifthecomputedratioisbelowa blacklisting these BGP sources will have little impact on1e+06
100000
10000
1000
100
10
1
0 10 20 30 40 50 60 70 80 90 100
secruos
fo
rebmuN
Num IPs that have hit spamtrap
Num IPs that have not hit spamtrap
Num spam IPs that have not hit spamtraps
Top 100 BGP prefixes for sources that missed the spamtraps
Figure6: Thetop100BGPprefixesforwhichwefailedtoblacklistanIPaddress. AlmostalloftheIPaddressesintheseprefixes
havepreviouslysentspam.
legitimatesources. 3.3 Implementation
Having described our broad approach, we now discuss
Inordertodetectthesesourcesthatdonothitspamtraps,
how e-mails from live networks and spamtraps are aggre-
wecanusethecontextoflocalnetworktraffictodetermine
gated, how blacklists are generated, how they are applied,
bad and good neighborhoods with respect to the network.
andhowentriesareremovedfromtheblacklists.
Forexample,considera/24networkaddressrangethathas
75activesources. If50ofthemarealreadyblacklistedthen
it is quite likely that the remaining 25 are also spammers 3.3.1 AggregatingSourcesinaMovingTimeWindow
fromtheperspectiveofthenetworkandthereforeaheuris-
Thetwostreamsofe-mailmessages, thespamtrape-mails
tic that also looks at the bad neighborhood may be able to
(badevents)andthelivenetworke-mails(goodevents),are
filteroutthesesources. Inordertoenlargethescopeofthe
mergedtogetherusingthee-mail’stimestamps. Sourcesare
blacklists, we leveraged topological information available
extractedandfedtotheblacklistgenerationalgorithms. We
through Border Gateway Protocol (BGP). BGP is used to
use a jumping window model to store network history. In
exchangeroutinginformationbetweenautonomoussystems
this model, the events are stored for a given time window
(AS) and helps identify organizational and logical bound-
and the time window jumps periodically. For example, in
aries.
asystemwithahistorywindowsizeof10hoursandape-
riodicjumpof15minutes,theeventsarekeptfor10hours
We aggregated traffic from spamtrap feeds and the live andthewindowjumpsby15minutes.Thecountsinthelast
network by BGP prefixes and autonomous systems. Then (oldest)15minutesarethenagedout.
weusedthreeparametersfordecidingtoblacklistanetwork Note that we do not process or annotate the network e-
asopposedtoindividualsources. First,theratioofgoodto mails(goodevents)inanyway. Asaresultthislivestream
bad e-mails for the network is below the ratio provided in may in fact contain spam e-mails directed at a legitimate
theratio-basedapproach. Secondtheratioofbadtoactive user. While this does not appear to have significantly im-
sourcesinanetworkshouldbeaboveaprovidedratio. This pacted the accuracy of our system (see Section 4), it does
parameter decides when we can speculatively classify an leaveopenthepossibilitythatanattackercouldimprovethe
entirenetworkasbad. However,wemayover-aggressively reputationofaspamsendingsourcebyonlysendingspam
blacklist networks when we have seen very sources from to legitimate users (hence avoiding our “classifier”). The
thatnetworkifwecommunicateveryinfrequentlywiththat use of additional “classifiers” (e.g., SpamAssassin) in the
networkandhavelittleinsightintothenetwork’sactivities. reputationassignmentandthecorrespondingerrorthatthe
Therefore, the final parameter is the ratio of the minimum maybeintroduced(seeSection4.5)areinterestingareasfor
numberofbadsourcestototalpossiblesources. furtherexploration.3.3.2 GeneratingBlacklists comparedintermsoftheirfalsepositiverateandfalseneg-
ativeratesaswellastimeandspaceperformance. Inaddi-
Forthemodelingofexistingapproaches,wecountthenum-
tion,wecomparethestabilityoftheapproachesforavariety
ber of bad events (i.e., spamtrap hits) for each source IP
ofchosenparameters. Thecomparisonisaccomplishedby
address and send those sources that cross a given thresh-
usingthedeploymentsdescribedinSection2.
old. Forthedynamicthresholdapproach, wecalculatethe
ratio of good events to bad events and send those sources
4.1 ComparingtheThreeApproaches
for which the ratio is below a given ratio. The count for
each address is taken over the history window. To enlarge
blacklists from source IP address to BGP prefixes and au- Wenowcomparethesimplemodelofexistingmethods
tonomoussystems,wetakeintoaccounttwoadditionalpa- withthetwoapproachesproposedinthepaper:thedynamic
rameters. ABGPprefixoranautonomoussystemisblack- thresholding approach and the speculative aggregation ap-
listedifallthreeconditionsaresatisfied—theratioofgood proach. Recall that in the threshold-based model, an IP
eventstobadeventsfortheprefixisbelowthegivenratio, address is blacklisted if it has more spamtrap hits than the
thenumberofbadIPaddressestoactiveaddressesisabove providedthreshold. Inthedynamicthresholdapproach,an
theminimumfraction, andtheratioofbadIPaddressesto IPaddressisblacklistediftheratioofthenumberofgood
totalpossibleaddressesisabovethespecifiedthreshold. events (e-mails to the live network) to the number of bad
events(e-mailstothespamtrap)isbelowthespecifiedratio.
In the speculative aggregation approach, the IP addresses
3.3.3 ApplyingBlacklists
are aggregated by BGP prefixes and autonomous systems.
Theblacklistsaregeneratedperiodicallyandthelistsarere- Then BGP prefixes or autonomous systems are blacklisted
freshedeachtime. Tosaveonmessaging,theblacklistgen- instead of individual IP addresses if it is found that these
eration technique only emits new entries or instructions to networksarenotofimportancetoone’snetwork. Sincethe
removeoldentries. Theseblacklistsareappliedtoe-mails speculative approach uses a dynamic threshold technique
from the live network until a new list is refreshed. In our for blacklisting individual IP addresses, it is essentially a
implementation, we maintained the blacklist as a list of IP combination of the dynamic threshold and speculation ap-
addressesintheopensourcedatabasePostgreSql. Weused proaches.
thePostgresGiSTindexip4rforquicklycheckingwhether Figure 7 shows the trade-off between the false negative
asourceIPisblacklisted. rate and the false positive rate for the three approaches.
First,wefindthatthedynamicthresholdingapproachyields
3.3.4 RemovalfromBlacklists a significantly better false negative rate for any false posi-
tiverateprovidedbythestaticthreshold-basedmodel.Con-
Finally, we need to define the policy for removing entries
versely, the dynamic threshold method provides a signifi-
from the blacklist. For existing approaches, an IP address
cantly better false positive rate for any false negative rate
is not blacklisted until the network has seen enough bad
providedbythestaticthreshold-basedmodel. Forexample,
eventsfromthatIPaddress. Whenthenetworkhistoryfor
thefalsenegativerateforthedynamicthresholdapproachis
anIPaddressgoeslowerthanthethreshold,theIPaddress
roughly20%betterthantheexistingmodelforfalsepositive
is removed from the blacklist. For the dynamic thresh-
ratesbelow0.5%,whichisroughlythreetimesthedetection
old approach, an IP address is removed from the blacklist
rateoftheexistingmodel.
whentheratioofgoodeventstobadeventsgoesabovethe
The speculative aggregation further improves detection
specifiedratio. BGPprefixesandautonomoussystemsare
rates over the dynamic thresholding approach. The false
removed from the blacklist if any of the three conditions
negativerateimprovementofthespeculativeapproachover
fail—the ratio of good to bad events exceeds the specified
the existing model is between 30-40% for false positive
ratio,orifthenumberofbadIPaddressestoactiveIPsfrom
rates below 0.5%, which is roughly 4-5 times the detec-
thenetworkfallsbelowtheprovidedthreshold,ortheratio
tion rate of the existing model. For false positive rates
of bad IP addresses to total possible addresses falls below
greaterthan0.5%,thedynamicthresholdingapproachpro-
thethreshold.
vides a slight improvement over the existing model. Over
this range, the speculative aggregation approach provides
4 Evaluation almostdoublethedetectionrateovertheexistingapproach.
Theoperationalpointforanapproachisusuallytheknee
In this section, we compare the three approaches to inthefalsenegativeandfalsepositivecurve. Fortheexist-
blacklistgeneration:thestaticthreshold-basedmodelofex- ing approach, the knee is at 0.67% of false positives and
istingapproaches,thedynamicthresholdingapproach,and 71% of false negatives, and for the dynamic threshold ap-
thespeculativeaggregationapproach.Theseapproachesare proach,thekneeisat0.31%offalsepositivesandat67%of!)##
!(#
!’#
!&#
!%#
!$#
!"#
!# !#*+ !#*" !#*% !#*’ !) !)*+ !)*" !)*%
987!03-6!0543-201!0/.-,
!!!!!!/3-34<
dynamic
/=0<>.-3450
,-./0!:;/43450!6-30!789
Figure7: Trade-offcurveforthefalsepositiverateandthefalsenegativerateforthethreemethodsforavarietyofparameter
values.Thespeculativeaggregationapproachoutperformsbothexistingmethodsanddynamicthresholdingapproachalone.
ExistingModel DynamicThresholding to1.Forthedynamicthresholdingapproach,theincreasein
Threshold FP FN Ratio FP FN falsepositivesismoregradual. Lookingatthedata,wefind
1 1.54 65.9 100.000 1.30 65.8 thatmanymailserversinthenetworkhadonespamtraphit
2 0.67 70.9 75.000 1.20 65.8 inthetimewindowof10hours.
3 0.54 74.6 50.000 1.05 65.8
4 0.51 77.3 25.000 0.83 65.8
4.3 Impact of Parameters on Speculative Aggre-
5 0.50 79.6 10.000 0.64 65.8
gation
10 0.47 86.8 5.000 0.52 65.9
15 0.29 90.7 1.000 0.31 66.9
20 0.28 92.6 0.010 0.15 74.1
Recall that in speculative aggregation, BGP prefixes or
25 0.09 93.7 0.005 0.11 76.3
autonomoussystemsareblacklistedifthreeconditionsare
30 0.08 96.9 0.001 0.09 76.4
satisfied. The first is if the ratio of good events (mails to
the live network) to bad events (mails to the spamtraps) is
Table 3: The values of the existing static threshold-based
below a specified ratio. The second is if the ratio of bad
modelandthedynamicthresholdingapproachesandthecor-
sources to total active sources is above a given threshold.
respondingfalsepositiveandfalsenegativerates.
Finally,thethirdisiftheratioofbadsourcestototalsizeof
theBGPprefixortheautonomoussystemisaboveagiven
false negatives. For the speculative aggregation approach, threshold.
thekneeisat0.40%offalsepositivesand48%offalseneg-
Figure8showsthevariationinthefalsepositiverateand
atives.
false negative rate for the speculative approach when the
above three parameters are varied. The default ratio was
4.2 The Effects of Existing Model and Dynamic keptat0.1andvariedfrom0.01to100.TheratioofbadIPs
ThresholdingParameterization tototalactivesourceswaskeptat0.4andvariedfrom0.1to
0.99. TheminimumratioofbadIPstototalpossibleIPsin
Inboththeexistingapproachandthedynamicthreshold- thenetworkwaskeptat0.01andvariedfrom0.001to0.1.
ingapproach,anetworkoperatorhastochoosethethresh- First, we find that the first and third parameters have sig-
old or the ratio for blacklisting. Since the thresholds are nificantimpactonthefalsepositiveandfalsenegativerates
chosen by hand, we need to investigate how stable these of the speculative aggregation approach. But varying the
schemes are for any given threshold. Table 3 shows the secondparameterhasverylimitedimpactontheapproach.
falsepositivesandfalsenegativesofthetwoapproachesfor Second,changingtheminimumnumberofbadIPaddresses
differentvaluesofthethresholdsandtheratios. Fortheex- providesamuchbettertrade-offbetweenthefalsepositive
isting approach, the false positive rate increases suddenly rateandthefalsenegativeratewhencomparedtochanging
from0.67%to1.54%whenthethresholdisreducedfrom2 theratioofgoodtobadevents.80
75
70
65
60
55
50
45
0 0.2 0.4 0.6 0.8 1 1.2
)%(
etaR
evitageN
eslaF
variation in ratio of good to bad events
varitation in the ratio of good to bad ips
variation in min bad ips
False Positive Rate (%)
Figure8:Impactofthreeparametersonthefalsepositiverateandfalsenegativerateforspeculativeaggregation.
Blacklist Lookup Index afalsepositiverateoflessthan1%andafalsenegativerate
size time(ms) size of around 5%. Obviously, the error in the oracle is likely
1000 0.045 40KB toimpacttheaccuracyofourmeasurements. Forexample,
10,000 0.046 264KB a false negative for the SpamAssassin oracle (i.e., a spam
100,000 0.050 3.7MB classified as ham) may appear as a false positive for the
1million 0.052 32MB blacklist,if,unliketheoracle,theblacklistcorrectlyidenti-
fiedthee-mailasspam.
Table4:Theimpactofblacklistsizeonthetimetolookupan Given the inaccuracy of SpamAssassin, the accuracy
IPaddress. Theindexsizegrowslinearly,butthelookuptime of false positives for the blacklist will be FP
blacklist
foranentryisveryfast. FN and the accuracy of false negatives for th± e
spamassassin
blacklist will be FN FP . Therefore,
blacklist spamassassin
±
4.4 Performance giventhevaluesof20%(orgreater)forthefalsenegatives
ofblacklistsand1%forthefalsepositivesthatappearinthis
Figure9showsthegrowthofblacklistsforthethreetech- paper, we arrive at or 1% 5% for the blacklist false pos-
±
niques: existing static threshold-based models, dynamic itivesand>20% 1%forthefalsenegatives. Clearlythe
±
thresholding and speculative aggregation. We find that smallfalsepositiverateoftheblacklistsislikelytobelost
the growth of blacklist size is highest for the ratio-based in the noise of the oracle. In order to overcome this prob-
techniquesandlowestforthespeculative-aggregationtech- lem,wehandclassifiedthefalsenegativesoftheSpamAs-
nique, as it combines many sources into BGP prefixes. In sassin. Instead of manually examining all false negatives
ordertoseehowblacklistsizemayimpacttheperformance oftheSpamAssassin(potentiallyalllegitimatee-mail),we
of the system, we created tables with different blacklist only hand classified sources that hit spamtraps (and hence
sizes in the database Postgresql (which is what we have weresenttonolegitimateuser).
used in our system). Then we created an index on the IP
addressesandprefixesusingGiSTindexinPostgresql. Ta-
5 RelatedWork
ble4showsthetimetolookupanentryandtheindexsize
fordifferentsizesoftheblacklist. Wefindthatthetimeto
lookupanentrydoesnotincreasesignificantly,andforthe Recentlyanumberofresearchpapershavelookedatthe
month’soperation,theindexsizeiseasilymanageable. algorithmstogenerateblacklists. Ramachandranetal.[20]
proposed a new method to blacklist source IP addresses
4.5 ImpactoftheOracleonAccuracy based on their e-mail sending patterns. However, their ex-
perimentisonlybasedone-mailsreceivedonthespamtraps
TovalidatetheaccuracyofSpamAssassin,wehandclas- andnotone-mailsreceivedonthelivenetwork.Asaresult,
sifiedseverale-mailboxesandfedthemtoSpamAssassin. theyonlyevaluatethefalsenegativesofspamtrapreceived
Aspublishedinourpreviousstudy[23],SpamAssassinhad e-mailandnotthefalsepositivesoftheirapproach. Inour3e+06
2.5e+06
2e+06
1.5e+06
1e+06
500000
0
02/07 02/14 02/21 02/28 03/07 03/14
tsilkcalb
eht
ni
seirtne
fo
rebmuN
threshold = 5
ratio = 1
ratio=1, leaf ratio=0.4
Time
Figure9:Thegrowthoftheblacklistsizeforthethreeapproaches.
study,wegenerateblacklistsbasedonspamtrape-mailsand nificantamountofspamisreceived. Accordingly,therehas
then apply them to the e-mail on the live network, so we beenincreasedinterestindevelopinglightweightmeasures
evaluatethefalsepositivesandfalsenegativesforthee-mail for reducing the load on an e-mail server. Venkataraman
onthelivenetwork. et al. [26] proposed coarse IP-based blacklists to reject e-
Xieetal.[29]haveshownthatalargenumberofIPad- mails and to reduce server load. They monitored e-mails
dressesaredynamicallyassignedande-mailsfromtheseIP on a mail server and used SpamAssassin score to identify
addressesaremostlyspam,sotheyrecommendaddingdy- spam and ham. The spam and ham ratio for IP addresses
namicIPrangesintoblackliststoreducethefalsenegatives. andIPclusterswerecomputedandthehistorywasusedfor
Zhangetal.[31]arguedthatacommonblacklistmaycon- blocking IP addresses in case of server overload. It is im-
tainentriesthatareneverusedinanorganization. Sothey portanttonotethattheyrequiredanexistingspamdetector
proposed an approach to reduce the size of the blacklists in order to create their IP blacklists. We do not rely on a
and possibly reduce the computational overhead in black- pre-existing spam detector and instead use e-mails on our
listevaluation. However,theirproposedapproachonlyim- deployedspamtrapsandthee-mailsontheproductionnet-
provestheblacklist”hit-rate”andnottheoverallfalsepos- worktogenerateblacklists. Whiletheirapproachisalight-
itiverateorthefalsenegativerateoftheblacklists. weight technique abstracted from an existing detector, our
approach is to build blacklists using traditional spamtraps.
Ramachandran and Feamster [19] collected spam by
Therefore,ourblacklistscanbeusedforimprovingaspam
monitoringe-mailssenttoanunuseddomainandperformed
detectorratherthanjustreducingtheloadontheserver.
a preliminary analysis of spammers. They observed that
thespammingsourcesareclusteredwithinIPaddressspace Xieetal.[30]usedaspamdetectortoclassifye-mailsas
and some of these sources are short-lived. Our approach spamandhamandthenproposedanautomatedwaytogen-
of speculative aggregation automatically identifies bad IP eratespamsignatures. However,theirapproachfocuseson
neighborhoodsbyconsideringthesourcesintheneighbor- usingmessagecontentfordevelopingsignatures. Similarly,
hoodsthathavehitthespamtrapsandthesourcesthathave Beverlyetal.[8]haveusedTCPinformationfromspamand
notyethitthespamtraps. hampacketleveldatatodevelopTCPlevelspamfeatures.
Anumberofpapershavequestionedtheeffectivenessof Kanichetal.[12]empiricallyevaluatedthesuccessrateand
blacklists. Ramachandranet. al.[18]analyzedhowquickly themonetizationfromspam. Rajabetal.[17]analyzedthe
BobaxinfectedhostsappearedintheSpamHausblacklists. botnetbehavioracrossanumberofdimensionsbutdidnot
They found that a large fraction of these hosts were not developanyautomatedwayofblacklistingthem.
foundintheblacklistanddemonstratedthedelayinblack- Most similar to this effort is the recent work of Hao et
listing. Wealsodemonstratetheproblemofdelayinblack- al. [11]. The authors used a spam detector to separate e-
listingandshowthatourproposedspeculativeaggregation mailsintohamandspam. Byexaminingthesee-mails,they
techniqueisabletoaddressthisproblem. identified a number of network level features that can be
E-mail servers can be easily overwhelmed when a sig- used to differentiate ham and spam. Hao et al. then usedmachine-learningmodelsonthosenetworkfeaturestobuild formalicioussoftware[15].Themainbenefitofthisworkis
aspamclassifier. SimilartoVenkataramanetal.[26],Hao toexaminetechniquesforreducingthisburden. Thegreat-
et al. relies on an existing spam detector to build the data est risk to the subjects of the study is the loss of privacy.
streams, which are used to feed the classifier and periodi- In an effort to minimize this harm, no personally identifi-
callyretrainit.Oureffortsaresimilartothisworkinthatwe able information of the subjects is published herein. The
havewealsoidentifiedfeaturesthatdifferentiatesspamand collected data was restricted to e-mail source and destina-
ham [23]. Rather then examining numerous features and tion servers only, except in the following two cases: (i)
combining them in a classifier, we focus on a small hand- wehandclassifiede-mailcontentsoffoursubject’sinboxes
ful of these features (e.g., remote BGP prefix clustering) withtheirexplicituserpermissioninordertodeterminethe
and explicitlyexplore the properties andtradeoffs of each. accuracyofouroracle(ii)wehandclassifiedthecontentsof
Further,whiletheworkofHaoetal. doesresultinalight- e-mailsnotmarkedbytheoracle,butthatweresenttoour
weight spam filter that performs on par with existing ap- spamtrap where no legitimate users preside. Because this
proaches,thefilterisofferedasanalternativeanddoesnot analysis was performed offline, no e-mails were modified
explore how existing blacklists fail and can be improved. duringthestudy.
Thekeydifferenceinthesetwosystems,however,istherole
oflocalandglobalinformationintheclassificationprocess.
Haoetal.issimilartoexistingblacklistdeploymentmodels
6.2 Limitations
inthattheclassifiersarebuiltfromglobalsourcesofinfor-
mation only and are not customized. We view this work
ascomplimentarytoHaoetal. inthatthelocalgeneration
While effective at its goal of addressing the limitations
and customization approach presented here could likewise
ofblacklistgeneration,thisworkhasseverallimitationsand
be applied to their classifier generation to yield improved
opportunitiesforfuturework. First, thespeculativeaggre-
accuracy.
gation technique presented in this paper is somewhat pre-
emptive in nature. While our evaluation shows that the
6 Discussions
proposedtechniqueprovidessignificantlybettertrade-offs,
it may be unacceptable to block traffic from hosts pre-
In this paper, we presented a detailed investigation of emptively. Second, like other reputation-based systems,
blacklist generation techniques using 2.5 million e-mails our blacklist generation system is also exposed to the at-
fromalargeacademicnetworkand14millione-mailsfrom tacks that increase or decrease the reputation of sources.
aspamtrapdeploymentin11domains. Wepresentedade- Whilethedynamicthresholdtechniqueprovidesprotection
tailedanalysisofhamandspamsources,basedonourown againstattackstoblacklistamailserver,itisstillvulnerable
spamtrap deployment that helps to explain the limitations toattackersincreasingthereputationofsourcesbysending
of existing spam blacklist approaches. We then proposed a large number of e-mails to a legitimate user. Currently,
two improvements to the standard threshold-based black- our system only counts the total number of e-mails on the
listapproach. Thefirstonereducesfalsepositivesbycom- livenetworkandisvulnerabletosuchanattack. Asystem
paring traffic on the live network to the spamtrap hits for that counts the number of unique users to which a source
blacklistingsources. Thesecondtakesnetworktrafficinto sends mail may be resilient to such an attack and will be
accounttosafelyaggregatebadsourcesintobadneighbor- exploredinthefuture. Third,blacklistprovidersoftenindi-
hoods. Theproposedtechniques,whencombinedtogether, catethattheyarenotresponsiblefortheblockingemailas
improved the false negative rate by 4-5x for false positive they only generate the blacklists, and it is the network ad-
ratesbelow0.5%and2xforfalsepositiveratesabove0.5%. ministratorswhoareblockingthee-mails. However, these
blacklistscurrentlyaregeneratedcentrally.Theonlyoption
6.1 Ethical Considerations for Spam Blacklist a network administrator has is to accept or reject a given
Evaluation blacklist. Our proposed deployment model requires either
publicationofrawspamtrapdatatosubscribersorthepub-
The increasing level of detailed access and subject in- licationof(aggregate)localnetworktrafficstatisticstothe
teractivityofInternetresearchexperimentsraisenumerous blacklistproviders,eachofwhichhaveobviouslimitations
ethicalissuesforresearch[9].Beneficencereferstothepro- (orattacksagainstthem). Finally,inourcurrentimplemen-
cess by which a researcher seeks to do good or seeks to tation,weonlyextractedthefirst“Received”headerinthe
maximize benefits while minimizing harm. As mentioned emailmessages. Inourdynamicthresholdmechanism,we
previously, the phenomenon of unsolicited bulk e-mail or could not blacklist sources if we did not blacklist the first
Spam is one that routinely impacts user productivity [21], source. Inthefuture,wemayliketoaddsupportforblack-
consumesresources[14],andservesasaninfectionvector listingofsourcesinreceivedheadersbeyondthefirstone.7 Acknowledgements [17] M.A.Rajab,J.Zarfoss,F.Monrose,andA.Terzis.Amulti-
facetedapproachtounderstandingthebotnetphenomenon.
In IMC ’06: Proceedings of the 6th ACM SIGCOMM on
We would like to thank the anonymous reviewers for
Internetmeasurement, pages41–52, NewYork, NY,USA,
theircommentsandextendspecialthankstoThorstenHolz,
2006.ACMPress.
ourshepherd,forhiseffortsinsignificantlyimprovingthis
[18] A.Ramachandran,D.Dagon,andN.Feamster. CanDNS-
paper. This work was supported in part by the Depart-
BasedBlacklistsKeepUpwithBots? . InProceedingsof
ment of Homeland Security (DHS) under contract num-
theThirdConferenceonEmailandAnti-Spam(CEAS2006),
bers NBCHC080037, NBCHC060090, and FA8750-08-2- July2006.
0147, the National Science Foundation (NSF) under con- [19] A. Ramachandran and N. Feamster. Understanding the
tractnumbersCNS091639,CNS08311174,CNS0627445, network-level behavior of spammers. In SIGCOMM ’06:
andCNS0751116, andtheDepartmentoftheNavyunder Conference on Applications, technologies, architectures,
contractN000.14-09-1-1042. and protocols for computer communications, pages 291–
302,NewYork,NY,USA,2006.ACMPress.
[20] A.Ramachandran,N.Feamster,andS.Vempala. Filtering
References spamwithbehavioralblacklisting.InCCS’07:Proceedings
ofthe14thACMconferenceonComputerandcommunica-
[1] Notjustanotherboguslist. http://njabl.org. tionssecurity,pages342–351,NewYork,NY,USA,2007.
[2] Pyzor. http://pyzor.sourceforge.net/. ACM.
[3] SorbsDNSBL. http://www.sorbs.net. [21] N.ResearchandKnowledgeStorm.Nucleusresearch:Spam
[4] SpamCop.net-Bewareofcheapimitations. http://www. costingusbusinesses$712peremployeeeachyear. http:
spamcop.net/. //nucleusresearch.com/news/press-releases/
[5] TheSpamHausProject. http://www.spamhaus.org. nucleus-research-spam-costing-us-businesses-
[6] Vipul’srazor. http://razor.sourceforge.net/. 712-per-employee-each-year/,April2007.
[7] What is the SpamCop Blocking List (SCBL)? http:// [22] M.Sahami, S.Dumais, D.Heckerman, andE.Horvitz. A
spamcop.net/fom-serve/cache/297.html. bayesian approach to filtering junk e-mail. In AAAI-98
[8] R.BeverlyandK.Sollins. Exploitingtransport-levelchar- Workshop on Learning for Text Categorization, pages 55–
acteristicsofspam. InProceedingsoftheFifthConference 62,1998.
onEmailandAnti-Spam(CEAS),Aug.2008. [23] S.Sinha,M.Bailey,andF.Jahanian. ShadesOfGrey: On
[9] D. Dittrich, M. D. Bailey, and S. Dietrich. Towards com- the effectiveness of reputation based blacklists. In Inter-
munitystandardsforethicalbehaviorincomputersecurity nationalConferenceonMaliciousandUnwantedSoftware
research. Technical Report 2009-01, Stevens Institute of (Malware2008),October2008.
Technology,Hoboken,NJ,USA,April2009. [24] B. Stone. Spam back to 94% of all e-mail, March
[10] H.Drucker,V.Vapnik,andD.Wu.Supportvectormachines 2009. http://bits.blogs.nytimes.com/2009/03/31/
forspamcategorization. IEEETransactionsonNeuralNet- spam-back-to-94-of-all-e-mail/.
works,10(5):1048–1054,1999. [25] Unspam Technologies. Project Honey Pot. http://
[11] S. Hao, N. A. Syed, N. Feamster, A. Gray, and projecthoneypot.org,2008.
S. Krasser. Detecting Spammers with SNARE: Spatio- [26] S. Venkataraman, S. Sen, O. Spatscheck, P. Haffner, and
temporal Network-level Automatic Reputation Engine. In D. Song. Exploiting network structure for proactive spam
UsenixSecurity’09,Montreal,Canada,August2009. mitigation. InProceedingsof16thUSENIXSecuritySym-
[12] C. Kanich, C. Kreibich, K. Levchenko, B. Enright, G. M. posium, pages 1–18, Berkeley, CA, USA, 2007. USENIX
Voelker,V.Paxson,andS.Savage. Spamalytics: anempir- Association.
ical analysis of spam marketing conversion. In CCS ’08: [27] G. L. Wittel and S. F. Wu. On attacking statistical spam
Proceedingsofthe15thACMconferenceonComputerand filters. InProceedingsoftheFirstConferenceonEmailand
communicationssecurity,pages3–14,NewYork,NY,USA, Anti-Spam (CEAS), 2004. Available: http://www.ceas.
2008.ACM. cc/papers-2004/170.pdf.
[13] J. Mason. Filtering Spam with SpamAssassin. SAGE-IE [28] R.Wojtczuk. libnids,June2004.
meetingpresentation,2002. [29] Y. Xie, F. Yu, K. Achan, E. Gillum, M. Goldszmidt, and
[14] McAfeeandI.International. Thecarbonfootprintofemail T.Wobber. HowdynamicareIPaddresses? InSIGCOMM
spam report. http://newsroom.mcafee.com/images/ ’07: Conference on Applications, technologies, architec-
10039/carbonfootprint2009.pdf,April2009. tures, and protocols for computer communications, pages
[15] T. Micro. Most abused infection vector. http://blog. 301–312,NewYork,USA,2007.
trendmicro.com/most-abused-infection-vector/, [30] Y.Xie,F.Yu,K.Achan,R.Panigrahy,G.Hulten,andI.Os-
December2008. ipkov. Spamming botnets: signatures and characteristics.
[16] B.Nelson,M.Barreno,F.J.Chi,A.D.Joseph,B.I.P.Ru- SIGCOMMComput.Commun.Rev.,38(4):171–182,2008.
binstein,U.Saini,C.Sutton,J.D.Tygar,andK.Xia. Ex- [31] J.Zhang,P.Porras,andJ.Ullrich. Highlypredictiveblack-
ploiting machine learning to subvert your spam filter. In listing. In17thUSENIXSecuritySymposium(USENIXSe-
FirstUSENIXWorkshoponLarge-ScaleExploitsandEmer- curity’08),July-August2008.
gentThreats,April2008.