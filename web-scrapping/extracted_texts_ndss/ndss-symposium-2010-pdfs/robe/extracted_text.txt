Effective Anomaly Detection with Scarce Training Data
WilliamRobertson FedericoMaggi ChristopherKruegel GiovanniVigna
∗ ∗
wkr@eecs.berkeley.edu fmaggi@elet.polimi.it chris,vigna @cs.ucsb.edu
{ }
UCBerkeley PolitecnicodiMilano ComputerSecurityGroup
UCSantaBarbara
Abstract 1 Introduction
TheInternethasevolvedfromitshumblebeginnings
Learning-basedanomaly detectionhas provento be
atCERNin1991intoamassivenetworkofubiquitous
aneffectiveblack-boxtechniquefordetectingunknown
services that spans the globe and reaches an estimated
attacks. However, the effectiveness of this technique
1.4billionpeople[27]. TheWorldWideWebcontains
crucially depends upon both the quality and the com-
more than 100 million sites [46] and around 1 trillion
pleteness of the training data. Unfortunately, in most
uniqueURLsasindexedbyGoogle[1]. Duetoitsper-
cases, the traffic to the system (e.g., a web applica-
vasive nature, the Internet – and in particular the Web
tion or daemon process) protected by an anomaly de-
– has become a predominant medium for disseminat-
tector is not uniformly distributed. Therefore, some
ingandcollectinginformation.Infact,webapplications
components (e.g., authentication, payments, or content
haveenjoyedimmensepopularityasanefficientmeans
publishing) might not be exercised enough to train an
for providing services to users. For instance, Face-
anomaly detection system in a reasonable time frame.
book has more than 250 million active users, upload-
This is of particular importance in real-world settings,
ing more than 1 billion photos each month, and Twit-
whereanomalydetectionsystemsaredeployedwithlit-
terdistributedmorethan3millionmessagesperdayin
tleornomanualconfiguration,andtheyareexpectedto
March2008[34].
automaticallylearnthenormalbehaviorofasystemto
Unfortunately, applications havebeen found to con-
detectorblockattacks.
tain many security vulnerabilities, due to a combina-
In this work, we first demonstrate that the features tion of unsafe development tools and a historical lack
utilized to train a learning-based detector can be se- of security awareness among developers. In addition,
manticallygrouped,andthatfeaturesofthesamegroup therisksaremagnifiedwhenvulnerablesoftwareisde-
tend to induce similar models. Therefore, we propose ployedinthecontextoftheWeb,sinceapplicationsare
addressinglocaltrainingdatadeficienciesbyexploiting typicallywidelyaccessibleandoftenhaveaccesstosen-
clustering techniques to construct a knowledge base of sitiveinformation. Thesefactorshavenaturallyresulted
well-trained models that can be utilized in case of un- in web-related vulnerabilities receiving substantial at-
dertraining. Ourapproach,whichisindependentofthe tention from the criminal underground [40]. As a con-
particular type of anomaly detector employed, is vali- sequence, the incidence of data breaches, online fraud,
datedusingtherealisticcaseofalearning-basedsystem andothercrimesresultingfromtheexploitationofweb
protecting a pool of web servers running several web applicationvulnerabilitiescontinuestorise[29,33],and,
applicationssuchasblogs,forums,orWebservices.We therefore,itisessentialtoprotectapplicationsandsys-
runourexperimentsonareal-worlddatasetcontaining temsconnectedtotheInternetagainstsuchattacks.
over58millionHTTPrequeststomorethan36,000dis- Anomalydetectionhasreceivedmuchattentionfrom
tinctwebapplicationcomponents.Theresultsshowthat theresearchcommunityasanapproachtodetectingand
byusingtheproposedsolution,itispossibletoachieve preventingunknownattacksbymonitoringanetwork’s
effectiveattackdetectionevenwithscarcetrainingdata. traffic[20,25,26,32,43,44,47]orahost’soperatingsys-
tem[3,14,21,24,28,31,38,42].Recently,anomaly-based
techniqueshavealsobeenshowntobeeffectiveagainst
Keywords:Anomalydetection,trainingdata,webappli- web-basedthreats[5,15,19,30]. Effectiveanomalyde-
cation. tectionsystemsareattractivebecausetheyconsiderthe
protected system as a black box. As a result, they canbe deployed in live environments without any a priori ing models will be prone to false negatives, as attack
knowledgeabouttheapplication. manifestationswillhavebeenlearnedasnormalbehav-
Anomalydetectionsystemscontainspecifications,or ior[8,10,17,39].
models,ofthenormalbehavioroftheprotectedsystem, Anotherlimitationthatiswell-knownintheresearch
andconsiderdeviationsfromthespecificationstobeev- community is the difficulty of obtaining enough high-
idence of malicious behavior. In contrast to signature- qualitytrainingdata. Unfortunately, toourknowledge,
based systems, anomaly detectors have the desirable no proposals exist that satisfactorily address the prob-
property that previously unknown attacks can be iden- lem. Inparticular,ourexperimentssuggestthatwebap-
tifiedautomatically. Thoughanomalydetectionmodels plicationcomponentinvocationsarenon-uniformlydis-
can be manually specified by domain experts, this is a tributed. That is, relatively few components dominate,
tedious,labor-intensive,anderror-proneprocess.There- and the remaining components are accessed relatively
fore,mostresearchhasinsteadfocusedonapplyingma- infrequently. Thus, for those components, it is often
chinelearningtechniquestoautomaticallyderivemod- impossibletogatherenoughtrainingdatatoaccurately
elsofnormalbehaviorfromunlabeledtrainingdata.The model their normal behavior. We informally refer to
termnormalbehaviorgenerallyreferstoasetofcharac- thecomponentsthatreceiveinsufficientaccessesasthe
teristics(e.g.,thedistributionofthesymbolsofstrings, “longtail”ofawebapplication.Notethat,however,this
orthemeanandstandarddeviationofthevaluesofnu- does not necessarily imply a power law distribution of
merical variables) extracted from data observed during theseaccesses.Nevertheless,componentsthatareinfre-
a system’s normal operation. For instance, such data quentlyaccessedleadtopoordetectioncapabilitiesdue
couldbethepayloadsofnetworkpackets,orHTTPre- toundertrainedmodels(i.e., modelspossessingknowl-
quests and responses exchanged between a web server edge limited to the low number of samples they have
andclients.Thosecharacteristicsareusedtobuildmod- beentrainedon).
elsofnormalbehavior. Learning-basedanomalydetec- This work addresses the problem of undertrained
tors obviate the tedious and error-prone task of creat- models by exploiting natural similarities among the
ingspecifications,and,additionally,areabletoadaptto modeledfeatures.Wedemonstratethishypothesisusing
the particular characteristics of the local environment. the web applications context as a real-world example.
Therefore, anomaly detectors typically require only a Inparticular,weshowthatthevaluesoftheparameters
modest initial configuration effort to provide effective extractedfromHTTPrequestscangenerallybecatego-
attackdetection. rizedaccordingtotheirtype,suchasaninteger,date,or
Inanidealcase,alearning-basedanomalydetection string. Moreover,ourexperimentsdemonstratethatpa-
system is deployed in front of a system and, in a com- rametersofsimilartypeinducesimilarmodelsofnormal
pletelyautomatedfashion,learnsthenormalinteraction behavior. Takentogether,theseresultscanbeleveraged
betweenthesystemanditsusers. Onceenoughtraining toeffectivelysupplementalackoftrainingdataforone
data has been analyzed and the profiles for the moni- web application component with similar data from an-
toredsystemshavebeenestablished,theanomalydetec- othercomponentthathasreceivedmorerequests.
torswitchestodetectionmode; itisthenabletodetect Inthispaper,wemakethefollowingcontributions:
attacksthatrepresentanomalieswithrespecttonormal
usage. These types of anomaly detection systems are Weintroducetheproblemthatarisesfromthefact
•
extremelyattractivetosecurityofficersandsiteadmin- thattrafficisdistributedinanon-uniformfashion,
istrators,whohaveneithertheresourcesnortheskillsto andweprovideevidencethatthisoccursinthereal
manuallyanalyzeapplicationscomposedofhundredsof worldinthecaseofwebapplications.
components. Because of this, several commercial web Weproposeanapproachtoaddresstheproblemof
•
application firewalls implement some form of machine undertraining by using global knowledge built by
learningtosupportanomalydetection[4,6,11]. exploitingsimilaritiesbetweenwebapplicationpa-
Learning-based anomaly detectors are not without rametersofsimilartype.
their drawbacks, however. In fact, these systems are We evaluate our approach on a large data set of
known for their tendency to produce a non-negligible • real-worldtrafficfrommanywebapplications,and
amount of false positives due to the difficulty of accu- demonstratehowanomalydetectorscanaccurately
rately modeling non-trivial domains. This is a limit- model those components that would otherwise be
ing factor for the effectiveness of such systems [2,13]. associatedwithundertrainedmodels.
An additional limitation is that anomaly detection sys-
temscriticallyrelyuponthequalityofthetrainingdata The results of our experiments show that by using
used to construct their models. In particular, training ourapproach,itispossibletoimprovethedetectionrate
sets must be free from attacks. Otherwise, the result- of undertrained models. In particular, web applicationr i,1 =/article, AshighlightedinFigure5,theinitialtrainingisper-
r =/comments, formed offline. During this phase, the anomaly detec-
 i,2 
R
i
=r
ri i, ,3
4
= =/ /c ao cm cm oe un nt t,s/edit,  t
t
so
i
oor
un
rl
s
ce ea inr pn
t
as
e tr
ht mh ,e
s
anb
o
de fh pma av
o
ri ado mer
l
eso
.
tf erAth
is
ne
sn
tm
e aw
no cn
w
eit seo
b
are red
ap
ow
p
ble
i
scb
ea rt
va ip
eo
dp
n
,l ,i tc
r
hea e--
Figure1:Examplr ei, r5 es= our/ ca ec sc coo mun prt i/ sip na gs as ww eo br ad pplication. s
r
aae pmt ps
le
iA
t ce
a,
r
tipR
oi
n,
,j,
aa kn od
ab
nP
s der
pa
v
ar
e
te
d
hu
i
rnpd aa ,st se aod
c
s.
eia
ttF
i
ooo fnr mwe oa
i
dc thh
ela
sun
tp
hi aq
ar
tu tie
cc
hup ala
a
r-
r
-
i i,j
acterizesthenormalbehaviorofvariousfeaturesofthe
componentsthathavereceivedonlyafewdozenrequests parameterisconstructed. Thesetofmodelsassociated
canbeprotectedalmostaseffectivelyasthosethatcom- witheachuniqueparameterinstancecanberepresented
ponentshavereceivedthousandsofrequests. as a tuple c = m ,m ,...,m ,...,m , referred
(.) " 1 2 u U #
to as a profile or model composition. Therefore, for
2 Trainingdatascarcity each application a i and resource path r i,j, a set i,j of
C
modelcompositionsisconstructed,oneforeachparam-
eter p P . The knowledge base of an anomaly
Tounderstandwhytheproblemofundertrainedmod- i,j,k ∈ i,j
detection system trained on web application a is de-
els exists, we first present a general description of an i
noted by = . A graphical representation of
anomaly detection system designed to protect web ap- Cai jCi,j
howaknowledgebaseismodeledformultiplewebap-
plications.Whilethisdescriptionisbasedonthesystem (
plicationsisdepictedinFigure2.
described in [19], we believe it represents an accurate
abstraction of web application anomaly detection. We
Tointroduceandaddresstheproblemofundertrain-
thenusetheseconceptstointroducethelong-tailprob-
ing, we leveragethe setof models described in[19] as
lemanditsramificationsonthefeasibilityofconstruct-
a real-world case. According to the system described
ingaccuratemodels.
in[19],aprofileforagivenparameterp isthetuple
i,j,k
Itisimportanttonotethatalthoughthereisnoestab- c = m(tok),m(int),m(len),m(char),m(struct) . m(tok)
i,j,k
lishedarchitectureforthesesystems, alargeportionof " #
models parameter values as a set of legal tokens (e.g.,
learning-basedanomalydetectorsaredesignedinasim-
the set of of possible values for the parameter gender
ilarmanner. Inparticular,theyextractsomesignificant observed during training). m(int) and m(len) describe
featuresfromthecapturedtraffic, estimatetheparame-
normalintervalsforintegersandstringlengths,respec-
tersofasetofpre-existingmodels(learningphase),and
tively, in a distribution-independent fashion using the
thenusethesemodelstoanalyzelivetrafficandrecog- Chebyshev inequality. m(char) models character strings
nize unexpected values of the selected features. Thus,
as a ranked frequency histogram, or Idealized Charac-
the description that follows can easily be generalized. ter Distribution (ICD), that are compared using the χ2
In addition, we remind the reader that a low detection or G tests. m(struct) models sets of character strings by
accuracy due to undertraining may affect any type of
inducing a Hidden Markov Model (HMM). The HMM
learning-based protection system, rather than those de-
encodesaprobabilisticgrammarthatcanproduceasu-
tectorsspecificallydesignedforthewebdomain.
persetofstringsobservedinatrainingset. Asidefrom
the addition of m(int), which is a straightforward gen-
2.1 Webapplicationanomalydetection eralizationofm(len) tonumericalranges, theinterested
readermayreferto[19]forfurtherdetails.
Withoutlossofgenerality, asetofwebapplications
Acanbeorganizedintoasetofresourcepathsorcom- After training, learning-based systems are typically
ponents R, and named parameters P. For example, switchedtodetectionmode,whichisperformedonline.
a web application a = blog.example.com might be Themodelstrainedinthepreviousphasearequeriedto
i
composedoftheresourcesshowninFigure1. determinewhetherornotthenewparametersobserved
In this example, resource path r might take a set areanomalous. Withoutgoingintothedetailsofapar-
i,5
of parameters as part of the HTTP request: P = ticular implementation, each parameter is compared to
i,5
p =id, p =oldpw, p =newpw . all the applicable models (e.g., an integer parameter is
i,5,1 i,5,2 i,5,3
{ }
Agenericlearning-basedapplicationintrusiondetec- compared to m(int), while a string parameter is com-
tion system operates by observing a sequence of re- paredtom(len),m(char),andm(struct))andanaggregated
quests Q = q ,q ,... issued by clients to the set of anomalyscoreontheinterval[0,1]iscalculatedbycom-
1 2
{ }
monitored applications. Each request q Q is repre- posingthevaluesreturnedbytheindividualmodels. If
∈
sented by the tuple a ,r ,P , where P is a set of theanomalyscoreisaboveacertainthreshold,analert
i i,j q q
" #
parametername-valuepairssuchthatP P . isgenerated.
q i,j
⊆http://blog.example.com,
Ca1
···
Cai
···
CaI ...
http://dav.example.com
/article,
/comments,
Cr1,1
··· ···
Cr1,j
··· ···
Cri,J ...
/account,
/account/password
id=1
c p1,1,1
···
c ( ·)
···
c ( ·)
···
c pi,j,k
···
c ( ·)
···
c ( ·)
···
c pi,j,K date=10 −11 −2004
title=foo
￿ ￿ ￿
m ,...,m m ,...,m m ,...,m
￿ 1 U ￿ ··· ￿ 1 U ￿ ··· ￿ 1 U ￿
Figure2:Overviewofwebapplicationmodelconstruction.
2.2 Theproblemofnon-uniformtrainingdata
/article=475,000
Because learning-based detectors dynamically build /comments=15,000
specifications of normal behavior from training data, it /comments/edit=9,000
isclearthatthequalityofthedetectioncriticallyrelies
/account=900
uponthequalityofthetrainingdata. Forinstance, one
/account/password=100
requirementtypicallyimposeduponatrainingsetisthat
it should be attack-free – that is, it should not contain
tracesofmaliciousactivitythatwouldinducetheresult- Figure4:Example non-uniform web application request dis-
ing models to consider malicious behavior as normal. tribution.
One solution to this issue is described in [8]. Another
requirement that a training set should satisfy is that it
should accurately represent the normal behavior of the Inthecaseoflow-trafficapplications,problemsarise
modeled features. In some ways, this requirement is iftherateofclientrequestsisinadequatetoallowmod-
thedualofthepreviousone: trainingdatashouldcom- els to train in a timely manner. However, even in the
pletelycoverallaspectsofnormalbehavior. case of high-traffic applications, a large subset of re-
sourcepathsmightfailtoreceiveenoughrequeststoad-
The difficulty of obtaining sufficient training data
equatelytrain1theassociatedmodels.Thisphenomenon
to accurately model application behavior is intuitively
is a direct consequence of the fact that requests issued
clear. Weare,however,notawareofanysolutionsthat
by clients often follow a non-uniform distribution. To
can address this issue when insufficient training data
illustratethispoint,Figure3plotsthenormalizedcumu-
is available. In a sense, this issue is similar to those
lative distribution function of web client resource path
addressed by statistical analysis methods with missing
invocationsforavarietyofreal-world,high-trafficweb
data[22]. Althoughatrainingprocedurewouldbenefit
applications (details on this data are provided in Sec-
fromsuchmechanisms,theyrequireacompleteredesign
tion4). Althoughseveralapplicationshaveanapproxi-
ofthetrainingalgorithmspecifictoeachmodel.Instead,
matelyuniformclientaccessdistribution,aclearmajor-
a non-obtrusive approach that can improve an existing
ityexhibitskeweddistributions. Indeed,inmanycases,
system without modifying the undertrained models is
a large percentage of resource paths receive a compar-
moredesirable.Typically,anomaly-baseddetectorscan-
ativelyminusculenumberofrequests. Returningtothe
not assume the presence of a testing environment that
exampleresourcesshowninFigure1,assuminganover-
can be leveraged to generate realistic training data that
allrequestvolumeof500,000requestsperday, theex-
exercisesthewebapplicationinasafe,attack-freeenvi-
ampleresourcepathsetmightresultintheclientaccess
ronment. Instead, the anomaly detection system is de-
distributionshowninFigure4.
ployedinfrontoflivewebapplicationswithnoapriori
Clearly,profilesforparameterstoresourcepathssuch
knowledgeoftheapplications’componentsandtheirbe-
as/articlewilllikelyreceivesufficienttrainingdata.
havior. If anomaly-based detectors required manual or
semi-automatictestingtobeeffective,theirmaintenance 1Amoreformaldefinitionoftheminimumamountofsamplesre-
wouldbeastediousasthatofmisuse-basedsystems. quiredforacompletetrainingisprovidedinSection3.1.1
0.8
0.6
0.4
0.2
0
0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1
FDC
sseccA
Site 1
Site 2
Site 3
Site 4
Site 5
Site 6
Site 7
Site 8
Site 9
Site 10
Site 11
Site 12
Site 13
Site 14
Site 15
Site 16
Site 17
Site 18
Site 19
Site 20
Site 21
Site 22
Site 23
Site 24
Resources
Figure3:Webclientresourcepathinvocationdistributionsfromaselectionofreal-worldwebapplications.
This is not true, however, for profiles associated with 3 Exploitingglobalknowledge
pathssuchas/account/password.Furtherexacerbat-
ingthesituationisthefactthataclientrequestdoesnot
The lack of available training data is a fundamental
necessarilyincludeallpossibleparameters.
obstacle when constructing accurate profiles for many
parameters of a web application. Without a minimum
Theinfeasibilityforananomalydetectionsystemto
number of requests to a given parameter, it is infeasi-
accuratelymodelalargesubsetofawebapplicationis
bletoconstructmodelsthatencodeareasonablyprecise
problematicinitself.Weargue,however,thattheimpact
approximationofnormalbehavior.
oftheproblemismagnifiedbythefactthatcomponents
We observe, however, that parameters associated
ofawebapplicationthatareinfrequentlyexercisedare
with the invocation of components belonging to differ-
alsolikelytocontainadisproportionatelylargeshareof
ent web applications often exhibit a marked similarity
securityvulnerabilities.Thisisaconsequenceofthere-
toeachother. Referringagaintotheexampleshownin
ducedamountoftestingthatdevelopersinvariablyper-
Figure1,manywebapplicationstakeanintegervalueas
form on less prominent components of a web applica-
a unique identifier for a class of objects such as a blog
tion,resultinginahigherrateofsoftwaredefects.Inad-
article or comment, as in the case of the id parameter.
dition, the relatively low request rate from users of the
Manywebapplicationsalsoacceptdaterangessimilarto
web application results in a reduced exposure rate for
thedateparameterasidentifiersorasconstraintsupon
these defects. Finally, when flaws are exposed and re-
asearchrequest. Similarly,asinthecaseofthetitle
ported,correctingtheflawsmaybegivenalowerprior-
parameter,webapplicationsoftenexpectashortphrase
itythanthoseinhighertrafficcomponentsofawebap-
oftextasaninput, orperhapsalongerblockoftextin
plication. Anexampleistheauthenticationmanagerof
theformofacommentbody. Onecanconsidereachof
ablog,whichreceivesalowshareofthetrafficifcom-
thesegroupingsofsimilarparametersasdistinctparam-
paredwiththecomponentthathandlesthecommentsor
eter types, though this need not necessarily correspond
thearchive.
to the concept of types as understood in the program-
Therefore,weconcludethatamechanismtoaddress minglanguagescontext.
theproblemofmodelundertrainingcausedbythenon- Thekeyinsightbehindourapproachisthatparame-
uniform distribution of training data is necessary for a tersofthesametypetendtoinducemodelcompositions
webapplicationanomalydetectionsystemtoprovidean thataresimilartoeachotherinmanyrespects. Conse-
acceptablelevelofsecurity. quently, if the lack of training data for a subset of thecomponents of a web application prevents an anomaly randomly sampled κ-sequences, where κ can take val-
detectionsystemfromconstructingaccurateprofilesfor uesin 8 2i (adiscussionofappropriatevaluesforκ
i=0
the parameters of those components, it is possible to isdeferreduntilSection3.4). Eachoftheresultingpro-
substitute profiles for similar parameters of the same files is( then added to a knowledge base I . Note that
Cai
type that were learned when enough training data was therandomsub-samplingisperformedwiththegoalof
available.Itmustbeunderlinedthatthesubstitutionop- inducingundertrainingtoshowthatclusteringisfeasible
erates at the granularity of parameters rather than re- andleadstothedesiredgroupingeven–andespecially
quests (which may contain more than one parameter). –inthepresenceofundertraining.
This increases the likelihood of finding applicable pro- In general, κ corresponds to a number of train-
filesimilarities,andallowsforthesubstitutionofmod- ingsamplesthatisconsideredinsufficienttoaccurately
elstakenfromradicallydifferentcomponents.However, characterizeafeature.This,however,warrantsadiscus-
althoughtheexperimentswerunonreal-worlddatacon- sionofwhatisconsideredsufficient.Anobviouschoice
firmthattheaforementionedinsightisrealistic,ourhy- is to fix a large, constant training phase length (e.g.,
pothesis might not hold in some very specific settings. 1000 requests). Unfortunately, an appropriate training
Thus,tominimizetherisksbroughtbymigratingglobal phaselengthisdependentuponthecomplexityofmod-
knowledgeacrossdifferentdeployments,weinterpreted elingagivensetoffeatures. Therefore,wehavedevel-
thisresultonlyasaninsightanddevelopedarobustcri- opedanautomatedmethodthatleveragesthenotionof
terion able to find similar profiles independently from modelstabilitytodeterminewhenamodelhasobserved
theactualtypesofthemodeledparameters. enough training samples to accurately approximate the
Ourapproachiscomposedofthreephases. Thefirst normalbehaviorofaparameter.
phase, shown in Figures 5 and 6b, is an extension of As new training samples are observed early in the
the training procedure originally implemented in [19], training phase, the state of a model typically exhibits
where undertrained versions of profiles are recorded in frequentandsignificantchangeasitsapproximationof
addition to their final states. In the second phase, a the normal behavior of a parameter is updated. Infor-
globalknowledgebaseofprofiles
C
= aiCai iscon- mally,inaninformation-theoreticsense,theaveragein-
structedoffline,where areknowledgebasescontain- formationgainofeachnewtrainingsampleishigh. As
Cai
(
ing only well-trained, stable profiles (right side of Fig- amodel’sstateconvergestoamorepreciseapproxima-
ure6a)fromanomalydetectionsystemspreviouslyde- tion of normal behavior, its state gradually exhibits in-
ployedonasetofwebapplications ia i. Theleftside frequent and incremental changes. In other words, the
ofFigure6adepictstheprogressiveconstructionofthe information gain of new training samples approaches
knowledgebase I = I ofun( dertrainedprofiles( zero,andthemodelstabilizes.
C aiCai
i.e., an index into , where I is a knowledgebase of Eachmodelmonitorsitsstabilityduringthetraining
C ( Cai
undertrainedprofilesfromthewebapplicationa ). Ad- phasebymaintainingahistoryofsnapshotsofitsinter-
i
ditionally, we define a mapping f : I nalstate.Periodically,amodelchecksifthesequenceof
C
×Cai
&→ C
(shown as a dotted, directed arrow) between under- deltasbetweeneachsuccessivehistoricalstateismono-
) *
trainedandwell-trainedprofiles. tonically decreasing and whether the degree of change
The third phase is performed online. For any new drops below a certain threshold. If both conditions are
webapplicationwhereinsufficienttrainingdataisavail- satisfied,thenthemodelisconsideredstable. Letκ(u)
stable
ableforacomponent’sparameter,theanomalydetector denote the number of training samples required for a
firstextractstheundertrainedprofilec !.Then,theglobal model to achieve stability. A profile is considered sta-
knowledgebase isqueriedtofindasimilar,previously blewhenallofitsconstituentmodelsarestable. Thus,
C
constructedprofilef I,c ! =c.Thewell-trainedpro- thenumberoftrainingsamplesrequiredforaprofileto
C
filecisthensubstitutedfortheundertrainedprofilec !in achievestabilityisgivenby
+ ,
thedetectionprocess.
κ =maxκ(u) . (3.1)
stable stable
3.1 PhaseI:Enhancedtraining u ∈U
Attheendofthisphase,thefinalstateofeachwell-
As a first step, we extended the anomaly detector trained, orstable, profileisstoredinaknowledgebase
described in [19] with a mechanism to generate under- . Both and I arecollectedfromeachwebap-
trainedprofilesfromadataset.Theseundertrainedpro- C pla ii cation,aC na di serveC aa si inputtothenextphase.
files are generated using the following procedure. Let
Instead of describing the internal stop criterion spe-
Q( ap i) = {q 1(p),q 2(p),... }denoteasequenceofclientre- cific to each model, if any, we developed a model-
questscontainingparameterpforagivenwebapplica- agnosticminimizationalgorithmdetailedinSection3.4
tion.OverQ( ap i)
,profilesaredeliberatelyundertrainedon (andevaluatedinSection4)thatallowsonetotradeoffI Clustering Q Training
Ca1
Q Training
a1
Ca1
... ... c c
I ￿
C
I
CaI
Q Training
aI
CaI C CI C
1st phase (offline) 2nd phase (offline) 3rd phase (online)
Figure5:Overall procedure. Profiles, both undertrained and well-trained, are collected from a set of web applications. These
profilesareprocessedofflinetogeneratetheglobalknowledgebase andindex I. Atanotherwebapplication,given
C C
anundertrainedprofilec!, canthenbequeriedtofindasuitablereplacementprofilec.
C
detectionaccuracyagainstthenumberoftrainingsam- jectstobeclusteredarecalculated. Asuitabledistance
plesavailable. function must reflect the semantics of the objects un-
derconsideration,andshouldsatisfytwoconditions: 1)
3.2 PhaseII:Buildingprofileknowledgebases theoverallsimilaritybetweenelementswithinthesame
clusterismaximized,and2)thesimilaritybetweenele-
The second phase consists of processing the output mentswithindifferentclustersisminimized.
ofthefirstphase,namelythesetsofknowledgebasesof We define the distance between two profiles to be
bothundertrainedandwell-trainedprofileslearnedfrom the sum of the distances between the models compris-
a variety of web applications. The goal is to create ing each profile. More formally, the distance between
and I,globalknowledgebasesofwell-trainedandunC - theprofilesc iandc j isdefinedas:
C
dertrainedprofiles,respectively,andamappingbetween
1
thetwo,allowing CI toserveasanindexto C. d(c i,c j)= c
i
c
j
δ u m( iu),m( ju) ,
| |m( iu),m.( ju) ∈ci cj / 0
3.2.1 Constructingglobalknowledgebaseindices - ! (3.2)
where δ : [0,1] is the distance
u u u
The construction of the undertrained profile database function defineM d be× twM een mo&→ dels of type u U =
I begins by merging a set of knowledge bases tok,int,len,char,struct . ∈
C CaI 1, CaI 2,..., CaI
I
that have previously been built by { The token model m} (tok) is represented as a set
a web application anomaly detector over a set of web of unique tokens observed during the training phase.
) *
applications ia iduringthefirstphase. Theprofilesin Therefore,twotokenmodelsm(tok) andm(tok)
arecon-
I are then clustered to group profiles that are seman- i j
C ( sideredsimilariftheycontainsimilarsetsoftokens.Ac-
tically similar to each other. Profile clustering is per-
cordingly,thedistancefunctionfortokenmodelsisde-
formedinordertotime-optimizequeryexecutionwhen
finedastheJaccarddistance[7]:
using I as an index into . The resulting clusters of
C C
p anro afi gl ge ls oi mn
eC
rI ata ivre ed he ien ro at re cd hib cy alH clI us=
terini
gh aI
i
l. gI on rit th hi msw uso ir nk g,
δ m(tok),m(tok) =1
m( itok) m( jtok)
. (3.3)
groupaveragelinkagewasapplied,a(
lthoughthecluster-
tok i j − 1 1m(tok)-m(tok)1
1
/ 0 1 i j 1
ingstageisagnosticastothespecificalgorithm.Inprin- 1 1
ciple,othermechanisms(e.g.,SupportVectorMachines, Theintegermodelm(int)isp1 1aramet( rizedby1 1thesam-
Locality-SensitiveHashing)tofindgroupsorclassesof plemeanµandvarianceσ2 ofobservedintegers. Two
similarmodelsbasedontheirfeaturescanbeused. We integermodelsm(int) andm(int) aresimilarifthesepa-
i j
opted for a clustering algorithm as a proof-of-concept rameters are also similar. Consequently, the distance
implementationofPhaseIIprimarilyduetoitssimplic- functionforintegermodelsisdefinedas:
ity. Foranin-depthdiscussionofclusteringalgorithms
andtechniques,wereferthereaderto[45]. σ i2 σ j2
funC cte in ot nr ,a wl hto ichan dy efic nlu es st her oi wng sia mlg ilo ar ri it th iem sbi es twth ee endi ts ht ean oc be
-
δ int /m( iint),m( jint) 0= 2
2
2σµ µi2 i 22 −
+
σµ µj2 j 222
2
2. (3.4)
i j
1κ=κmin
cp9c, pκ
10,κ
cp3,κcp7,κ
cp9cp10 cp3
cp7
CκI
min c
cp8,κ cp6,cκ
p2,cκ
p5,κ
cp8 cp6cp2cp5
cp4c ,κp1,κ cp4cp1
κ=4
cp9c,
p4
10,4
cp3,c 4p7,4
C4I
cp8,4 cp6,4cp2,c4
p5,4
cp4,4cp1,4
κ=2
cp9c,
p2
10,2
cpc 3p ,7 2,2
C2I
cp8,2 cp6,2c
cp p2 5, ,2
2
cp4,2 cp1,2
κ=1
cp
c9 p,1
10,1
cp3,1cp7,1
C1I
cp8,1 cp6,1cp2,1cp5,1
cp4,1cp1,1
κ=0
(a) (b)
deniart-lleW
κstable￿κmin
C
κ=64
κ=32
κ=16
κ=8
κ=4
κ=2
κ=1
)p(QnistseuqeR
Figure6:Globalknowledgebaseindices(a)constructedby(b)sub-samplingthetrainingsetQintosmallchunksofsamplesof
progressivelylargersize(asdetailedinSection3.1). In(b),adotindicatesasampleforacertainparameter,andafull
trainingsetforoneparametercorrespondstoonehorizontalrowofdots. Forinstance, atκ = 2, theprofilesforthe
sameparameteraretrainedseveraltimeson2-sizedtrainingsubsets. Thisleadstotheprofilesindicatedassmallgray
dotsin(a) I andthat,inthisexample,canbegroupedintothreeclustersaccordingtotheirsimilarity. Asexplained
C2
in Section 3.2.1, as κ increases, more accurate clusterings are achieved, and the undertrained knowledge base better
resemblesthewell-trainedoneshownonthetop-right.
Asthelengthmodelisinternallyidenticaltotheinte- Thestructuralmodelm(struct)buildsanHMMbyob-
germodel,itsdistancefunctionδ isdefinedsimilarly. serving a sequence of character strings. The resulting
len
Recall that the character distribution model m(char) HMM encodes a probabilistic grammar that can pro-
learnsthefrequenciesofindividualcharacterscompris- duceasupersetofthestringsobservedduringthetrain-
ing strings observed during the training phase. These ing phase. The HMM is specified by the tuple S,
"
frequenciesarethenrankedandcoalescedintonbinsto O, M ,P(S,O), P(S) . Several distance metrics
createanICD.Twocharacterdistributionmodelsm(char) have bS e× eS n proposed to eva# luate the similarity between
i
andm(char)
areconsideredsimilarifeachmodel’sICDs
HMMs[16,23,36,37].Theirtimecomplexity,however,
j
is non-negligible. Therefore, we adopt a less precise,
aresimilar. Therefore,thedistancefunctionforcharac-
butconsiderablymoreefficient,distancemetricbetween
terdistributionmodelsisdefinedas
two structural models
m(struct)
and
m(struct)
as the Jac-
n i j
δ m(char),m(char) = )b i(l) −b j(l) ), (3.5) carddistancebetweentheirrespectiveemissionsets
char i j max b (l)
k=i,j k
/ 0 .l=0 δ m(struct),m(struct) =1 |Oi Oj |. (3.6)
whereb i(k)isthevalueofbinkform( ichar) . struct
/
i j
0
− |Oi-Oj
|
(3.2.2 Constructingaglobalknowledgebase global knowledgebase and index are available, the sit-
uation is considerably improved. Given and I, the
Once a knowledgebase of undertrained models I has C C
C anomalydetectorcansimplyapplyf toeachoftheun-
beenbuilt,thenextstepistoconstructaglobalknowl-
dertrainedparameterstofindawell-trainedprofilefrom
edge base . This knowledge base is composed of the
C theglobalknowledgebasethataccuratelymodelsapa-
individual,well-trainedknowledgebasesfromeachweb
rameterwithsimilarsemantics,evenwhenthemodelis
application as recorded during the first phase – that is,
for another web application. Then, these profiles can
= . Becauseundertrainedprofilesarebuiltfor
C iCai be substituted for the undertrained profiles for each of
each well-trained profile in , a well-defined mapping
f :
(I
(i.e.,
independC
ent from the particular un-
{id,oldpw,newpw }.Aswillbedemonstratedinthefol-
! C &→ C lowing section, the substitution of global profiles pro-
dertrainedmodelin ,asdefinedbyf)existsbetween
Cai vides an acceptable detection accuracy for what would
I and . Therefore,whenawebapplicationparameter
C C otherwisebeacompletelyunprotectedcomponent(i.e.,
isidentifiedaslikelytobeundertrained,thecorrespond-
withouta profile, none of theattacks againstthatcom-
ingundertrainedprofilec canbecomparedtoasimilar
! ponentwouldbedetected). Ifnomatchingwell-trained
undertrained profile in I, that is then used to select a
C profiles can be found, then the undertrained profile is
correspondingstableprofilefrom .2
C useduntiltheknowledgebaseisupdatedatalatertime.
This ensures that our approach can be deployed trans-
3.3 Phase III: Mapping undertrained profiles
parentlyandisadoptedonlywhenapplicable,incurring
towell-trainedprofiles
no additional risk or overhead to the existing detection
procedure.
With the construction of a global knowledge base
C
andanundertrainedknowledgebase I,wecanperform
C 3.4 Mappingquality
onlinequeryingof .Thatis,givenanundertrainedpro-
C
filefromananomalydetectordeployedoverawebap-
plication a , the mapping f : I is im- Theselectionofanappropriatevalueforκiscentral
i
C
×Cai
&→ C to both the efficiency and the accuracy of querying .
plementedasfollows. Anearest-neighbormatchisper- C
) * Clearly,itisdesirabletominimizeκinordertobeable
formedbetweenc andthepreviouslyconstructed
clusters HI
from!
∈ IC
toai
discover the most similar clus- to index into C as quickly as possible once a parame-
C ter has been identified to be subject to undertraining at
terofundertrainedprofiles. Thisisdonetoavoidafull
run-time. Ontheotherhand,settingκtoolowisprob-
scanoftheentireknowledgebase,whichwouldbepro-
hibitivelyexpensiveduetothecardinalityof I. lematic.Infact,asFigure6aindicates,forlowvaluesof
C κ,profilesaredistributedwithrelativelyhighuniformity
Then, using the same distance metric defined in
within I,suchthatclustersin I aresignificantlydif-
Equation (3.2), a nearest-neighbor match is performed C C
betweenc
!
andthemembersofHI todiscovertheun- ferentthanclustersofwell-trainedprofilesin C. There-
dertrained profile cI at minimum distance from c. If fore,slightdifferencesinthestateoftheindividualmod-
! elscancauseprofilesthatareclosein I tomaptorad-
multiple nearest-neighbors are found, then one is cho- C
ically different profiles in . As κ κ , however,
sen at random. Finally, the global, well-trained profile C → stable
f cI = cissubstitutedforc forthewebapplication profiles tend to form semantically-meaningful clusters,
! !
andtendtoapproximatethosefoundin . Therefore,as
a i.
+ , κ increases, profiles that are close in
C
I become close
To make explicit how global profiles can be used C
in accordingtof –inotherwords,f becomesrobust
to address a scarcity of training data, consider the ex- C
withrespecttomodelsemantics.3
ample of Figure 4. Since the resource path /ac-
Aprincipledcriterionisrequiredforbalancingquick
count/password has received only 100 requests, the
indexingagainstarobustprofilemapping. Tothisend,
profiles for each of its parameters id,oldpw,newpw
{ } we first construct a candidate knowledge base I for a
are undertrained. According to our confidence met- Cκ
givenκ. Additionally,weclustertheprofilesin asin
ric defined in Section 3.1, models that have received C
thecaseoftheundertrainedknowledgebase. Then,we
less than 1000 samples are likely undertrained (i.e.,
definearobustnessmetricasfollows. RecallthatHI =
with a confidence close to zero). In the absence of
hI isthesetofclustersin I,andletH = h be
a global knowledge base, the anomaly detector would i i C i i
providenoprotectionagainstattacksmanifestingthem-
(thesetofclustersin C. Letg :HI &→Z+beam (apping
fromanundertrainedclustertothemaximumnumberof
selves in the values passed to any of these parameters.
Also, the system may report too many false positives 3Ouruseoftheterm“robustness”isrelated, butnotnecessarily
due to a lack of model generalization. If, however, a equivalent,tothedefinitionofrobustnessinstatistics(i.e.,theproperty
ofamodeltoperformwelleveninthepresenceofsmallchangesin
2Notethatf!isageneralizationoff. theunderlyingassumptions.)elementsin that cluster that map to the samecluster in samplesvaluesobservedduringtrainingareincludedto
.Therobustnessmetricρisthendefinedas giveanideaoftheparameter’s“type.” Asκincreases,
C
profilesareclusteredmoreaccurately.
1
ρ I = g hI . (3.7) As the figure indicates, the resulting clusters in
C I i C
areaccuratelygroupedbyparametertype. Forinstance,
|C | i
+ , . + ,
dateparametersfromdifferentwebapplicationsbelong
Withthismetric,anappropriatevalueforκcannow
a single hierarchy, while unstructured text strings are
bechosenas
groupedintoaseparatehierarchy.
κ =min ρ I ρ , (3.8)
min κ Cκ ≥ min 4.2 Profilemappingrobustness
+ + , ,
whereρ isaminimumrobustnessthreshold.
min
Recall that in order to balance the robustness of the
mapping f between undertrained profiles and global
4 Evaluation
profilesagainstthespeedwithwhichundertrainingcan
be addressed, it is necessary to select an appropri-
Thegoalofthisevaluationisthree-fold.First,wein- ate value for κ. To this end, we generated under-
vestigatetheeffectsofprofileclustering,andsupportthe trained knowledge bases for increasing values of κ =
notion of parameter types by examining global knowl- 1,2,4,8,16,32,64fromthesamedatasetusedtogener-
edge base clusters. Then, we study how the quality ate ,followingtheprocedureoutlinedinSection3.2.1.
ofthemappingbetweenundertrainedprofilesandwell- TheC resultinghierarchicalclustersforvariousκarepre-
trained profiles improves as the training slice length κ sentedinFigure7c,7d,7a.
is increased. Finally, we present results regarding the At low values of κ (e.g., Figure 7c), the clustering
accuracyofawebapplicationanomalydetectionsystem processexhibitsnon-negligiblesystemicerrors. Forin-
incorporatingtheapplicationofaglobalknowledgebase stance,theparameterstatshouldbeclusteredasato-
toaddresstrainingdatascarcity. ken set of states, but instead is grouped with unstruc-
The experiments that follow were conducted using tured strings such as cities and addresses. A more ac-
a data set drawn from real-world web applications de- curate clustering would have dissociated the token and
ployedonbothacademicandindustrywebservers. Ex- stringprofilesintowell-separatedsub-hierarchies.
amples of representative applications include payroll As shown in Figure 7d, larger values of κ lead to
processors, client management, and online commerce more semantically meaningful groupings. Some inac-
sites. For each application, the full content of each curaciesarestillnoticeable,buttheclusteringissignif-
HTTP connection observed over a period of approxi- icantlybetterthattheoneobtainedatκ = 8. Afurther
mately three months was recorded. A portion of the improvement in the clusters is shown in Figure 7a. At
resultingflowswerethenfilteredusingSnorttoremove κ = 64, theseparationbetweendatesandunstructured
knownattacks.Intotal,thedatasetcontains823distinct strings is sharper; except for one outlier, the two types
web applications, 36,392 unique components, 16,671 are recognized as similar and grouped together in the
uniqueparameters,and58,734,624HTTPrequests.4
earlystagesoftheclusteringprocess.
Figure 8 plots the profile mapping robustness ρ
4.1 Profileclusteringquality against κ for different cuts of the clustering hierarchy,
indicatedbyD . D isathresholdrepresentingthe
max max
Toevaluatetheaccuracyoftheclusteringphase,we maximumdistancebetweentwoclusters.ForlowD ,
max
first built a global knowledge base from a collection the “cut” will generate many clusters with a few ele-
C
of well-trained profiles. The profiles were trained on a ments. Ontheotherhand,forhighvaluesofD ,the
max
subsetoftheaforementioneddata,containingtrafficin- algorithmwilltendtoformlessclusters,eachhavinga
volvingawidevarietyofwebapplications. Thissubset larger number of elements. In general, D can in-
max
wascomposedof603webapplications, 27,990unique fluencetheresultofaclusteringalgorithmsignificantly.
resourcepaths,9,023uniqueparameters,and3,444,092 Figure 8, however, shows two important properties of
HTTP requests. The clustering algorithm described in our technique. First, it demonstrates that the robust-
Section3.2.2wasthenappliedtogroupprofiles.Sample ness is fairly insensitive to D . Second, the robust-
max
resultsfromthisclusteringareshowninFigure7b.Each nessofthemappingincreaseswithκuntilsaturationat
leafrepresentsaprofile.Thenameoftheparameterand 32 κ 64. This not only confirms the soundness
≤ ≤
ofthemappingfunction,butitalsoprovidesinsightson
4Unfortunately, duetocontractualagreements, weareunableto
theappropriatechoiceofκ tominimizethedelayto
disclosespecificinformationidentifyingthewebapplicationsthem- min
selves. global profile lookup while maximizing the robustnessstdate: {01/01/1900, 04/01/2007, 05/01/2007}
stdate: {01/01/1900, 04/01/2007, 05/01/2007}
ref: {01/29/2007, 01/30/2007, 01/31/2007}
stdate: {02/19/2004, 09/15/2005, 12/07/2005}
stdate: {01/01/1900, 05/08/2006}
stdate: {01/31/2006, 11/01/2006}
notes: {1/29/07 - email, 10/26/06 thru, spoke} stdate: {01/30/2007, 02/10/2007}
notes: {1/29/07 - email, 10/26/06 thru, spoke} indate: {01/29/2007, 12/29/2006}
notes: {1/29/07 - email, 10/26/06 thru, spoke} exp: {01/01/2008, 05/22/2007}
exp: {02/09/2007, 09/30/2006}
notes: {1/29/07 - email, 10/26/06 thru, spoke}
exp: {02/01/2007, 08/01/2006, 09/01/2006}
type: {health care, wholesale} date: {1/29/07, 12/31/2006}
notes: {1/29/07 - email, 10/26/06 thru, spoke} date: {1/29/07, 12/31/2006}
name: {Foo LLC, Bar Inc.} note: {10-5, no ans, called and emailed, no client resp}
type: {General Auto, Painters, unknown} note: {10-5, no ans, called and emailed, no client resp}
(a)κ=64 (b)κstable"103
city: {OUR CITY, OTHER CITY, San Diego} thepage: {TKGGeneral, TKGGeneral, KZDA.pdf}
stat: {GA}
updateTask: {TKGGeneral, KZDA.pdf, Chan.cfm?taskna}
code: {OD}
w: {Ineligible, Old} code: {CK-1006, NES}
cd: {XX} thepage: {TKGGeneral, TKGGeneral, KZDA.pdf}
type: {Payment, Sales} code: {CK-1006, NES}
code: {OD} thepage: {TKGGeneral, TKGGeneral, KZDA.pdf}
w: {Eligible, New} accode: {r94, xzy}
w: {Ineligible, New} code: {CK-1006, NZS}
stat: {CA, TX} code: {CK-1006, NZS}
stat: {CA, TX} code: {02-286, BE2}
addr: {15 ROOF AVE, 373 W SMITH, 49 N Ave} thepage: {TKGGeneral, TKGGeneral, KZDA.pdf}
(c)κ=8 (d)κ=32
Figure7:Graphicalrepresentationofthevariousstepsofthehierarchicalclusteringof ,(a-b),and I,(c-d),atvariousκ. Each
C C
leafrepresentsaprofile.Thenameoftheparameterandsamplesvaluesobservedduringtrainingareincludedtogivean
ideaoftheparameter’s“type.”Wenotethatthesesamplevaluesareshownforvisualizationpurposesonly,andarenever
takenintoaccountbytheclusteringalgorithm.Asκincreases,profilesareclusteredmoreaccurately.
ofthemapping. the intended usage of the technique. In total, this data
setconsistedof220uniquereal-worldwebapplications,
4.3 Detectionaccuracy 8,402uniqueresourcepaths,7,648distinctparameters,
and55,290,532HTTPrequests.
Having studied the effects of profile clustering and Thethreatmodelweassumeisthatofanattackerat-
varying κ upon the robustness of the profile mapping temptingtocompromisetheconfidentialityorintegrity
f,aseparateexperimentwasconductedtoevaluatethe ofdataexposedbyawebapplicationbytamperingwith
detection accuracy of an anomaly detector incorporat- request parameters.5 Therefore, a set of 100,000 at-
ing the knowledge bases and I constructed in the tacks was introduced into the data set. These attacks
C C
previous experiments. In particular, the goal of this werereal-worldexamplesandvariationsuponcross-site
experiment is to demonstrate that an anomaly detector scripting(XSS),SQLinjection,commandexecutionex-
equippedwithaglobalknowledgebaseexhibitsanim- ploits,andotherattacksthatmanifestthemselvesinre-
proved detection accuracy in the presence of training questparametervalues.6 Examplesoftheseattacksin-
datascarcity.Asdetailedinthefollowing,wemeasured clude:
thebaselineaccuracy,onthesamesystemandunderthe
sameconditions,withallthemodelsundertrained. malicious code inclusion: <script
•
Thedatausedinthisexperimentwasasubsetofthe src="http://example.com/malware.js"></script>;
full data set described above, containing traffic from bypassingloginauthentication:’ OR ’x’=’x’--;
•
one related set of web applications implementing on-
linecommercesites. Thisdatasetwascompletelydis-
5Althoughtheanomalydetectorusedinthisstudyiscapableof
detectingmorecomplexsession-levelanomalies,werestrictthethreat
joint from the one used to construct the global knowl-
modeltorequestparametermanipulationbecausewedonotaddress
edgebaseanditsindices,topreventanypotentialforthe sessionprofileclusteringinthiswork.
substitution of profiles from the same application. Ad- 6Theseattacksremainthemostcommonattacksagainstwebap-
ditionally,theuseofaglobalknowledgebasegenerated plications. However,boththeanomalydetectorandtheimprovement
wedesignedapplytoanymaliciousactivitycausedbymodifications
from many types of web applications to address a lack
toHTTPrequests,andthereforewebynomeanslimitourscopeto
of training data for a specific web application mirrors theseclassesofattacks.0.5
0.45
0.4
0.35
0.3
0.25
0.2
0 10 20 30 40 50 60 70
ssentsubor
gnippaM D = 0.10 max
D = 0.125
max
D = 0.15
max
D = 0.175
max
D = 0.20
max
D = 0.225
max
D = 0.25
max
D = 0.30
max
D = 0.35
max
D = 0.375
max D = 0.40
max
D = 0.425
max
D = 0.45
max
D = 0.475
max
D = 0.50
max
κ
Figure8:Plotofprofilemappingrobustnessforvaryingκ.
command injection: ; cat /etc/passwd | mail systems. Clearly, the detection accuracy will improve
•
attacker@gmail.com #. asmoretrainingsamples(e.g.,128,256)becomeavail-
able. However,thegoalofthisexperimentwastoeval-
Toestablishaworst-caseboundonthedetectionac- uate such an improvement with a very limited training
curacyofthesystem,profilesforeachobservedrequest set, rather than showing the detection maximum accu-
parameter were deliberately undertrained to artificially racyachievable.
induce a scarcity of training data for all parameters. Oneconcernregardingthesubstitutionofglobalpro-
That is, for each value of κ = 1,2,4,8,16,32,64, the filesforlocalrequestparametersisthataglobalprofile
anomaly detector prematurely terminated profile train- that was trained on another web application might not
ingafterκsamples,andthenusedtheundertrainedpro- detect valid attacks against the undertrained parameter.
filestoquery . Theresultingglobalprofileswerethen Withoutthistechnique, however, recallthatalearning-
C
substituted for the undertrained profiles and evaluated based web application anomaly detector would other-
against the rest of the data set. The sensitivity of the wise have no effective model whatsoever, and, there-
systemwasvariedovertheinterval[0,1],andtheresult- fore, the undertrained parameter would be unprotected
ingROCcurvesforeachκareplottedinFigure9. bythedetectionsystem. Furthermore, theROCcurves
It must be noted that, as shown in Section 4.2, with demonstratethatwhileglobalprofilesareingeneralnot
κ=1oursystemcannotreliablyfindsemanticallysim- as precise as locally-trained models, they do provide a
ilar well-trained models. As κ increases, so does the significantlevelofdetectionaccuracy.7 Moreprecisely,
quality of the global profiles returned by the querying withκ=1,undertrainingconditionandsystemoff,only
process. In particular, this increase in quality closely 67.5% of the attacks are detected, overall, with around
follows the mapping robustness plot presented in Fig- 5%offalsepositives. Ontheotherhand, withκ = 64
ure 8. As predicted, setting κ = 32,64 leads to fairly (undertrainingandsystemon),morethan91%oftheat-
accurateglobalprofileselection,withtheresultingROC tacksaredetectedwithlessthan0.2%offalsepositives
curves approaching that of fully-trained profiles. This (vs., 0.1% of false positives in the case of no under-
means that even if the component or, in general, a pa- training and system off). Therefore, we conclude that,
rameterofawebapplicationhasreceivedonlyafewre- assuming no mistrust among the parties that share the
quests(i.e.,64),byleveragingaglobalknowledgebase,
itispossibletoachieveeffectiveattackdetection. Asa
7Notethatifglobalprofileswerefoundtobeasaccurateaslocal
profiles,thiswouldconstituteanargumentagainstsite-specificlearn-
consequence, our approach can improve the effective-
ingofmodels,sinceinthatcase,modelscouldbetrainedforoneweb
ness of real-world web application anomaly detection applicationandapplieddirectlytootherwebapplications.1
0.9
0.8
0.7
0.6
0.5
0 0.01 0.02 0.03 0.04 0.05
etar
evitisop
eurT
k=1
k=2
k=4
k=8
k=16
k=32
k=64
k-stable
False positive rate
Figure9:GlobalprofileROCcurvesforvaryingκ. Inthepresenceofsevereundertraining(κ κ ),thesystemisnotable
! stable
torecognizemostattacksandalsoreportsseveralfalsepositives.However,asκincreases,detectionaccuracyimproves,
andapproachesthatofthewell-trainedcase(κ=κ ).
stable
global knowledge base, our approach is a useful tech- nique to higher-order n-grams is introduced in [43].
nique to apply in the presence of undertrained models Thissystemisalsonotableforitsinclusionofastopcri-
and,ingeneral,inthecaseoftrainingdatascarcity. terionforendingmodeltrainingbyestimatingthelikeli-
hoodofobservingnewn-grams;thisapproachisrelated
tothenotionofmodelstabilitydescribedinSection3.1.
5 Relatedwork
One of the first applications of anomaly detection
techniques to the web domain is described in [19], in
Anomalydetectionhasarichhistorythatdatesback
whichamulti-modelapproachtocharacterizingthenor-
to Denning’s seminal paper on intrusion detection [9].
mal behavior of web application parameters is shown
It has been extensively applied to modeling legal se-
to reliably detect web attacks while maintaining a low
quencesofsystemcalls[12,42]aswellasothersystem
falsepositiverate.In[18],theuseofBayesiannetworks
callfeatures[28].Network-basedanomalydetectionhas
isproposedtocomposemodelsandexpressinter-model
alsobeenextensivelystudied[21,41].
dependencies in order to further reduce false positive
In [24], the authors further exploit the use of statis-
rates. A system for clustering anomalies and classify-
ticallearningprocedurestobuildmodelsofnormalse-
ingclustersaccordingtothetypeofattackisproposed
quences of system calls in the Linux kernel. Here, ad-
in[30]toimprovetheexplanatorypowerofwebappli-
hocdistancesareproposedtoperformclusteringofsys-
cationanomalydetectionaswellasfurtherreducetheir
temcallsinordertoidentifytypesofsimilarcalls.Thus,
falsepositiverate.
the system calls are “compacted” and the reduced size
oftheinputmakesitfeasibletotrainMarkovchainsthat A recent effort on addressing training set deficien-
attempttocapturethebehaviorofeachhostapplication. cieshasbeenproposedin[8]. Inthiswork, asanitiza-
Probabilisticthresholdsarethenusedtodetectdeviating tionphaseisfirstperformedtoremovesuspectedattacks
behaviors. andotherabnormalitiesfromthedata. Insteadofcreat-
Anomalydetectiontechniqueshavealsobeenapplied ingonemodelinstance,asetof“micro-models”istrai-
at the application level. In [44], Wang and Stolfo de- ned against disjoint subsets of the training data. These
scribePAYL,aservice-agnosticanomalydetectionsys- micro-models are then subject to one of several voting
temthatmodelsnormalbehaviorbyrecordingbytefre- schemes to recognize and cull outliers that may repre-
quenciesofnetworkstreams. Anextensionofthetech- sent attacks. While this work is somewhat related toours in that slices of training data are considered, the oftrainingdatabyexploitingglobalsimilaritiesinweb
application of micro-models is intended to ensure that applicationparameters. Wehaveevaluatedtheefficacy
attacksarenotpresentintrainingdata. Incontrast,our of this approach over an extensive data set collected
approachiscomplementaryinthesensethatitisfocused from real-world web applications. We found that al-
onaddressingthelackoftrainingdata. thoughusingglobalprofilesdoesresultinasmallreduc-
In[13],theauthorsproposeacluster-basedanomaly tion in detection accuracy, the resulting system, when
detectionsystemasameansofreducingfalsepositives. given appropriate parameters, does provide reasonably
Thesystemaccomplishes thisby clusteringsimilarbe- precisemodelingofotherwiseunprotectedwebapplica-
havioralprofilesforindividualhostsusingthek-means tionparameters.
algorithm, althoughtheexactdistancemetricusedwas Asfuturework,weplantoinvestigatetheextension
notexplicitlygiven. Then, alertsaregeneratedaccord- ofglobalmodelclusteringtoothertypesofmodels,par-
ing to a voting scheme, where the causal event for an ticularlyHTTPresponseandsessionmodels. Anaddi-
alert is evaluated against behavior profiles from other tionallineoffutureworkistoinvestigatetheapplication
members of that host’s cluster. If the event is deemed of different clustering methods in order to improve the
anomalousbyallmembersofthecluster,analertisgen- efficiencyofthequeryingprocedureforhigh-cardinality
erated.Thoughthissystemsharestheelementofprofile knowledgebases.
clustering with our work, the scope of the clustering is
limitedtoendhostsconnectedtoasingleswitch,while
Acknowledgments
our work clusters across a large population of web ap-
plicationprofiles. Also,themodelsoperateovercoarse
Theauthorswishtothanktheanonymousreviewers
network statistics such as the average number of hosts
andourshepherd, AngelosStavrou, fortheirinsightful
contacted per hour, the average number of packets ex-
comments. This work has been supported by the Na-
changedperhour,andtheaveragelengthofpacketsex-
tionalScienceFoundation,undergrantsCCR-0238492,
changedperhour. Oursystem, ontheotherhand,con-
CCR-0524853, and CCR-0716095, by the European
sidersfine-grainedfeaturesspecifictowebapplications.
Union though the grant FP7-ICT-216026-WOMBAT,
Finally, our system does not require the use of a dis-
andbySecureBusinessAustria(SBA).
tributed voting scheme, which incurs additional over-
head.
References
Arecentproposalfortheanomaly-baseddetectionof
web-based attacks is presented in [35]. In this work,
amixtureofMarkovchainsincorporatingn-gramtran- [1] J. Alpert and N. Hajaj. We knew the web was
sitions is used to model the normal behavior of HTTP big... http://googleblog.blogspot.com/2008/
requestparameters. Theresultingsystemattainsahigh
07/we-knew-web-was-big.html,July2008.
[2] S.Axelsson.TheBase-RateFallacyandtheDifficultyof
detection accuracy for a variety of web-based attacks.
IntrusionDetection. ACMTransactionsonInformation
In contrast to our work, however, a single mixture is
andSystemSecurity,3(3):186–205,August2000.
learned for an entire web application. Additionally,
[3] S. Bhatkar, A. Chaturvedi, and R. Sekar. Dataflow
theproposedsystemutilizesasupervisedlearningalgo- AnomalyDetection. InProceedingsoftheIEEESym-
rithm(i.e.,attacksmustbelabeledassuchinthetraining posiumonSecurityandPrivacy(S&P2006),Oakland,
set),whereasoursoperatesonunlabeledtrainingdata. CA,USA,May2006.IEEEComputerSociety.
[4] Breach Security, Inc. Breach WebDefend. http://
www.breach.com/products/webdefend.html, Jan-
6 Conclusions
uary2009.
[5] S. Cho and S. Cha. SAD: Web Session Anomaly De-
Inthiswork,wehaveidentifiedthatnon-uniformweb tection Based on Parameter Estimation. Computers &
client access distributions cause model undertraining. Security,23(4):312–319,2004.
This is an issue that must be addressed by web appli- [6] Citrix Systems, Inc. Citrix Application Fire-
cationanomalydetectionsystemsinordertoprovidea wall. http://www.citrix.com/English/PS2/
reasonablelevelofsecurity. Theimpactofthisissueis products/product.asp?contentID=25636, Jan-
uary2009.
particularlyrelevantforcommercialweb-basedanomaly
[7] W.Cohen,P.Ravikumar,andS.Fienberg. Acompari-
detection systems and web application firewall, which
sonofstringdistancemetricsforname-matchingtasks.
havetooperateinreal-worldenvironmentswheresuffi-
InProceedingsoftheIJCAI-2003WorkshoponInforma-
cienttrainingdatamightbeunavailablewithinareason-
tionIntegrationontheWeb(IIWeb-03),2003.
abletimeframe. [8] G. F. Cretu, A. Stavrou, M. E. Locasto, S. J. Stolfo,
We propose the use of global knowledge bases of and A. D. Keromytis. Casting out Demons: Sanitiz-
well-trained,stableprofilestoremediatealocalscarcity ingTrainingDataforAnomalySensors. InProceedingsoftheIEEESymposiumonSecurityandPrivacy(S&P [22] R.LittleandD.Rubin. Statisticalanalysiswithmissing
2008), pages 81–95, Oakland, CA, USA, May 2008. data. WileyNewYork,1987.
IEEEComputerSociety. [23] R.B.Lyngsø,C.N.S.Pedersen,andH.Nielsen.Metrics
[9] D. E. Denning. An Intrusion-Detection Model. IEEE andsimilaritymeasuresforhiddenmarkovmodels. In
TransactionsonSoftwareEngineering, 13(2):222–232, ProceedingsoftheSeventhInternationalConferenceon
1987. Intelligent Systems for Molecular Biology, pages 178–
[10] H. J. Escalante and O. Fuentes. Kernel Methods for 186.AAAIPress,1999.
Anomaly Detection and Noise Elimination. In Pro-
[24] F.Maggi,M.Matteucci,andS.Zanero.Detectingintru-
ceedingsoftheInternationalConferenceonComputing
sionsthroughsystemcallsequenceandargumentanal-
(CORE2006),pages69–80,MexicoCity,Mexico,2006.
ysis(preprint). IEEETransactionsonDependableand
[11] F5 Networks, Inc. BIG-IP Application Se-
SecureComputing,99(1),2009.
curity Manager. http://www.f5.com/
[25] M. Mahoney and P. Chan. Detecting novel attacks by
products/big-ip/product-modules/
identifyinganomalousnetworkpacketheaders. Techni-
application-security-manager.html, January
calReportCS-2001-2, FloridaInstituteofTechnology,
2009.
2001.
[12] S. Forrest, S. A. Hofmeyr, A. Somayaji, and T. A.
[26] M. V. Mahoney and P. K. Chan. Learning Rules for
Longstaff. ASenseofSelfforUnixProcesses. InPro-
AnomalyDetectionofHostileNetworkTraffic. InPro-
ceedings of the IEEE Symposium on Security and Pri-
ceedingsoftheIEEEInternationalConferenceonData
vacy(S&P1996),pages120–128,Oakland,CA,USA,
Mining,2003.
May1996.IEEEComputerSociety.
[13] V. Frias-Martinez, S. J. Stolfo, and A. D. Keromytis. [27] Miniwatts Marketing Group. World Internet Usage
Behavior-ProfileClusteringforFalseAlertReductionin Statistics. http://www.internetworldstats.com/
AnomalyDetectionSensors. InProceedingsoftheAn- stats.htm,January2009.
nual Computer Security Applications Conference (AC- [28] D.Mutz,F.Valeur,C.Kruegel,andG.Vigna. Anoma-
SAC2008),Anaheim,CA,USA,December2008. lousSystemCallDetection.ACMTransactionsonInfor-
[14] J.T.Giffin,D.Dagon,S.Jha,W.Lee,andB.P.Miller. mationandSystemSecurity,9(1):61–93,February2006.
Environment-SensitiveIntrusionDetection. InProceed- [29] Open Security Foundation. DLDOS: Data Loss
ings of the International Symposium on Recent Ad- Database–OpenSource. http://datalossdb.org/,
vances in Intrusion Detection (RAID), pages 185–206. January2009.
Springer-Verlag,2005. [30] W. Robertson, G. Vigna, C. Kruegel, and R. A. Kem-
[15] L.Guangmin. ModelingUnknownWebAttacksinNet- merer.UsingGeneralizationandCharacterizationTech-
work Anomaly Detection. In Proceedings of the 3rd niquesintheAnomaly-basedDetectionofWebAttacks.
International Conference on Convergence and Hybrid In Proceedings of the Network and Distributed Sys-
InformationTechnology(ICCIT2008),pages112–116, temSecuritySymposium(NDSS2006),SanDiego,CA,
Washington,DC,USA,2008.IEEEComputerSociety. USA,February2006.
[16] B.JuangandL.Rabiner. Aprobabilisticdistancemea-
[31] R.Sekar, M.Bendre, D.Dhurjati, andP.Bollineni. A
sureforhiddenMarkovmodels. AT&TBellLaborato-
Fast Automaton-Based Method for Detecting Anoma-
riesTechnicalJournal,64(2):391–408,1985.
lous Program Behaviors. In Proceedings of the IEEE
[17] S.-i. Kim and N. Nwanze. Noise-Resistant Payload
SymposiumonSecurityandPrivacy(S&P2001),pages
Anomaly Detection for Network Intrusion Detection
144–155, Oakland, CA, USA, May 2001. IEEE Com-
Systems. In Proceedings of the Performance, Com-
puterSociety.
putingandCommunicationsConference(IPCCC2008),
[32] R.Sekar, A.Gupta, J.Frullo, T.Shanbhag, A.Tiwari,
pages 517–523, Austin, TX, USA, December 2008.
H.Yang,andS.Zhou.Specification-basedAnomalyDe-
IEEEComputerSociety.
tection: ANewApproachforDetectingNetworkIntru-
[18] C. Kruegel, D. Mutz, W. Robertson, and F. Valeur.
sions. InProceedingsoftheACMConferenceonCom-
BayesianEventClassificationforIntrusionDetection.In
puterandCommunicationsSecurity(CCS2002),pages
ProceedingsoftheAnnualComputerSecurityApplica-
265–274,NewYork,NY,USA,2002.ACMPress.
tionsConference(ACSAC2003),LasVegas,NV,USA,
[33] O. Shezaf, J. Grossman, and R. Auger. Web Hack-
December2003.
ing Incidents Database. http://www.xiom.com/
[19] C.Kruegel,W.Robertson,andG.Vigna.AMulti-model
whid-about,January2009.
ApproachtotheDetectionofWeb-basedAttacks. Jour-
nalofComputerNetworks,48(5):717–738,July2005. [34] A. Singer. Social Media, Web 2.0 And Internet
[20] C. Kruegel, T. Toth, and E. Kirda. Service-Specific Stats. http://thefuturebuzz.com/2009/01/12/
AnomalyDetectionforNetworkIntrusionDetection. In social-media-web-20-internet-numbers-stats/,
Proceedings of the Symposium on Applied Computing January2009.
(SAC2002),Spain,March2002. [35] Y.Song,A.D.Keromytis,andS.J.Stolfo.Spectrogram:
[21] W.LeeandS.J.Stolfo. AFrameworkforConstructing AMixture-of-Markov-ChainsModelfor Anomaly De-
Features and Models for Intrusion Detection Systems. tectioninWebTraffic. InProceedingsoftheNetwork
ACMTransactionsonInformationandSystemSecurity, and Distributed System Security Symposium (NDSS
3(4):227–261,2000. 2009),SanDiego,CA,USA,February2009.[36] A.StolckeandS.Omohundro. HiddenMarkovModel
Induction by Bayesian Model Merging. Advances in
Neural Information Processing Systems, pages 11–11,
1993.
[37] A. Stolcke and S. Omohundro. Inducing Probabilistic
GrammarsbyBayesianModelMerging. LectureNotes
inComputerScience,pages106–106,1994.
[38] G. Tandon and P. Chan. Learning Rules from System
CallArgumentsandSequencesforAnomalyDetection.
InICDMWorkshoponDataMiningforComputerSecu-
rity(DMSEC),pages20–29,2003.
[39] G.Tandon,P.Chan,andD.Mitra. MORPHEUS:Mo-
tif Oriented Representations to Purge Hostile Events
fromUnlabeledSequences. InProceedingsofthe2004
ACM Workshop on Visualization and Data Mining for
ComputerSecurity,pages16–25,WashingtonDC,USA,
2004.ACM.
[40] D.Turner,M.Fossi,E.Johnson,T.Mark,J.Blackbird,
S.Entwise, M.K.Low, D.McKinney, andC.Wueest.
Symantec Global Internet Security Threat Report –
Trendsfor2008. TechnicalReportXIV,SymantecCor-
poration,April2009.
[41] A.ValdesandK.Skinner.Adaptive,Model-basedMon-
itoringforCyberAttackDetection. InH.Debar,L.Me,
and F. Wu, editors, Proceedings of the International
SymposiumonRecentAdvancesinIntrusionDetection
(RAID 2000), number 1907 in Lecture Notes in Com-
puterScience,pages80–92,Toulouse,France,October
2000.Springer-Verlag.
[42] D.WagnerandD.Dean. IntrusionDetectionviaStatic
Analysis. In Proceedings of the IEEE Symposium on
SecurityandPrivacy(S&P2001),pages156–168,Oak-
land,CA,USA,2001.IEEEComputerSociety.
[43] K.Wang,J.J.Parekh,andS.J.Stolfo.Anagram:ACon-
tentAnomalyDetectorResistanttoMimicryAttack. In
ProceedingsoftheInternationalSymposiumonRecent
Advances in Intrusion Detection (RAID 2006), Ham-
burg,GR,September2006.Springer-Verlag.
[44] K. Wang and S. J. Stolfo. Anomalous Payload-based
NetworkIntrusionDetection. InProceedingsoftheIn-
ternational Symposium on Recent Advances in Intru-
sionDetection(RAID2004).Springer-Verlag, Septem-
ber2004.
[45] R.XuandD.Wunsch. Surveyofclusteringalgorithms.
IEEETransactionsonNeuralNetworks,16(3):645–678,
2005.
[46] R.H.Zakon. Hobbes’InternetTimelinev8.2. http:
//www.zakon.org/robert/internet/timeline/,
November2006.
[47] S. Zanero and S. M. Savaresi. Unsupervised learning
techniques for an intrusion detection system. In Pro-
ceedingsofthe2004ACMSymposiumonAppliedCom-
puting,pages412–419.ACMPress,2004.