Panoply:
Low-TCB Linux Applica5ons
With SGX Enclaves
Shweta Shinde Dat Le Tien
Shru5 Tople Prateek Saxena
Na#onal University of SingaporeTCB: Hos5ng a Web Server
Current systems have a large TCB
183 KLOC
Webserver
10 MLOC
150 KLOC
Opera5ng
System
Hypervisor
2SGX: Hardware-root of Trust
Web
Other
Server
Applica5ons
Enclave
Ring 3 RAM
Opera5ng System / VMM
Ring 0 - 2
EPC
Trusted
Untrusted
3SGX: Hardware-root of Trust
183 KLOC
Webserver
10 MLOC
150 KLOC
Opera5ng
System
Hypervisor
Confiden5ality
and Integrity
Hardware
Enclave
4..but limSiGtsX t ehleim eixnparteesss iavlel ntheess of the
nona-pappplicliac5a5oonns (seo.Ug.w, naore s fyrsocmall Ts)C B..
5TCB & Expressiveness Trade-off
TCB
LibraryOS
Haven [OSDI’14] Graphene-SGX [EuroSys’14]
~1MLOC
Containers
~100KLOC
?
Scone [OSDI’16]
Ryoan [OSDI’16]
~KLOC
Expressiveness
6Contribu5ons
• Panoply
– Expressiveness: All standard POSIX APIs
– Low TCB: 2 orders of magnitude smaller than LibraryOS
– Library-enclaves for fine-grained TCB
• EvaluaCon
– Absolute 24% and 5-10% compared to LibraryOS
7Problem
8Challenge I: Expressiveness vs TCB
Syscalls
Fork Emula5on
Event Management
Threading
Webserver Thread Handling
Event
Handling Syscall Emula5on
Web Server
Forking
Legacy Applica5on Design Enclave TCB
9Challenge I: Expressiveness vs. TCB
Expressiveness TCB
10Challenge II: Mul5-Enclave
Applica5ons
zzlliibb
Web Server libssl
lliibbeevveenntt
lliibbccrryyppttoo
lliibbssssll
Opera5ng System
WWeebb
SSeerrvveerr
Mul5-Enclave
Single Enclave
Applica5on
Applica5on
11Ajacks on Mul5-Enclave Applica5ons
session_t session;
certificate_credentials_t xcred;
/* Specify callback function*/
[SSL Lib]
certificate_set_verify_function (...);
/* Initialize TLS session */
init (&session, TLS_CLIENT);
Set SSL
OS
Callback
Webserver SSL Library
Enclave Enclave 12Ajacks on Mul5-Enclave Applica5ons
OS
Webserver
SSL Library
Enclave
Enclave
Drop
Spoof
Replay
13Our Solu5on: Panoply
14Panoply Run5me
Microns keep libc outside the enclave
Micron
Enclave-b ound Logic
Enclave
Panoply Shim Lib Trusted SGX Lib
Non-enclave Untrusted
libc.so
Logic SGX Lib
Non- Enclave
Linux User-level Process
15Overview
Source
Compiler Creating
1
2
Code
Instrumentation Enclaves
Enclave-bEo1u nd E1
Add calls to
Code
Panoply API E3
E2
Intel
ApE 2
Panoply
Add Flow
SGX
Shim
Checks
SDK
Panoply
Programmer
Application
Annotations Panoply
16Challenge I: Expressiveness
Delegate rather than emulate
On-
Mul5-
demand
processing
threading
Event
Syscalls
Handling
Enclave
17Expressiveness: Panoply APIs
Core Services Real-Cme Extensions
5
Process Crea5on and Control Real-Time Signals 4
6
Signals 1
Clocks and Timers
5
Timers 2
Semaphores
37
File and Directory Opera5ons 7
Message Passing
4
Pipes 6
Shared Memory
66
C Library (Standard C) Asynchronous and 29
I/O Port Interface Synchronous I/O
40
and Control
6
Memory Locking Interface
Thread Extensions
Thread Crea5on, Control, 17
POSIX APIs
and Cleanup
4
Thread Scheduling Supported for
10
Thread Synchroniza5on
Commodity Linux Apps
2
Signal Delivery
3
Signal Handling 18Expressiveness Example: Fork
LibraryOSes emulate fork seman5cs
Fork Seman5cs LibraryOS Fork Implementa5on
Parent Child
Parent Child
Enclave Enclave
Process Process
Page Copy Page Copy
Page Copy PID Mgmt PID Mgmt
OS
PID Mgmt OS
19Expressiveness Example:
Delega5ng Fork
• Crea5ng child process and child enclave
Parent Enclave Child Enclave
Parent Process Child Process
Panoply
Fork OS
PID Mgmt
• Child enclave has a clean memory state
20Expressiveness Example:
Achieving Fork Seman5cs
• Mirroring parent’s memory in child enclave
– AUer the fork call, before resuming execu5on
Parent Enclave Child Enclave
Stack Heap Data Stack Heap Data
Parent
Child Process
Process
Sealed
Data
OS
21Expressiveness Example:
Achieving Fork Seman5cs
• Mirroring parent’s memory in child enclave
– Full replica: default mode in Panoply
• Alterna5ve strategies to full replica
– Copy on demand: Requires page-fault support
from SGX v2
– Copy on need: Replicate selected addresses which
are pre-determined by sta5c analysis
22Expressiveness Example: Mul5-Threading
Virtual Threads
TCS TCS TCS
TCS TCS TCS
1 2 3
1 2 3
Micron A’
Micron A
Panoply Shim
Panoply Shim
Shared Variables
Thread Control
Manager Micron
23Challenge II: Mul5-enclave
Applica5ons
24Securing Mul5-Enclave Apps
Enclave
Pair-wise
Iden5ty
Nonce
OS
Call Ack
Enclave 2
Enclave 1
ALack Security Property
Spoofing Sender / Receiver Authen5ca5on
Replay Message Freshness
Silent Drops Reliable Delivery
25Evalua5on
26Benchmarks
• Real-world use-cases for SGX
– 4 apps: Tor, H2O web server, FreeTDS, OpenSSL
• Opera5ng system stress tes5ng
– 26 LMBench benchmarks tests
– 17 metrics for memory, network, signal, syscall APIs
27TCB Evalua5on
Panoply Graphene-SGX
Component LOC Component LOC
Glibc 1156740
Panoply Library 10425
libPal-LinuxSGX 16901
API Wrappers 9788
libPal-enclave 33103
Total 20213
Total 1206744
Panoply reduces TCB by 2 orders of magnitude
28Performance Evalua5on
• Create delete takes large frac5on of the 5me
• Overhead increases with number of Out-Calls
Panoply incurs 24% overhead
App Panoply Empty Overhead
Enclave (% increase)
OpenSSL 3.16 2.79 13
H2O 8.79 6.56 34
FreeTDS 8.74 8.60 1
Tor 6.72 4.54 48
Average 24
29Throughput Evalua5on
30Throughput Evalua5on
Overhead for SGX-apps is propor5onal to
the size of requests
31Comparison with Graphene-SGX
32Comparison with Graphene-SGX
Panoply performance varies by 5-10% as
compared to Graphene-SGX
33Conclusion
TCB
~1MLOC
~100KLOC
- 254 APIs
Panoply - 20KLOC
~KLOC
- 24%Overhead
Expressiveness
34Contact
• Shweta Shinde
shweta24@comp.nus.edu.sg
• Panoply Benchmarks & Case-studies:
hjp://shwetasshinde24.github.io/Panoply/
Thank You !
35References
• [OSDI’ 14] A. Baumann, M. Peinado, and G. Hunt, Shielding
Applica5ons from an Untrusted Cloud with Haven
• [OSDI’ 16] S. Arnautov, B. Trach, F. Gregor, T. Knauth, A.
Mar5n, C. Priebe, J. Lind, D. Muthukumaran, D. O’Keeffe,
M. L. S5llwell, D. Goltzsche, D. Eyers, R. Kapitza, P. Pietzuch,
and C. Fetzer, SCONE: Secure Linux Containers with Intel
SGX
• [OSDI’ 16] T. Hunt, Z. Zhu, Y. Xu, S. Peter, and E. Witchel,
Ryoan: A Distributed Sandbox for Untrusted Computa5on
on Secret Data
• [EuroSys’ 14] Graphene-SGX Library OS - a library OS for
Linux mul5-process applica5ons, with Intel SGX support
36